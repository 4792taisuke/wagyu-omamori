<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wagyu Blessing Amulet | #wagyu_blessing</title>
  <meta name="description" content="Create a Japanese Omamori-style blessing card for travelers.">
  <style>
    :root{
      --bg: #10b7b0;
      --ink: #0f2b2e;
      --omamori: #b91c1c;
      --panel: #f5e7c4;
      --outline: #111111;
      --gold: #f6d889;
      --gold-dark: #d8b86a;
      --btn: #125a5a;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:#ece8d3;
    }
    header{padding:18px 22px}
    h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,36px)}
    .sub{opacity:.8}
    .wrap{
      display:grid;
      gap:20px;
      align-items:flex-start;
      grid-template-columns:minmax(280px,420px) 1fr;
      padding:0 22px 28px;
    }
    .card{
      background:#fffffff0;
      border:1px solid #0001;
      border-radius:16px;
      box-shadow:0 10px 24px #0001;
    }
    .panel{padding:16px;position:relative;z-index:1;}
    .controls .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    input,select,button{font-size:16px}
    input[type=text],select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #0002;
    }
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
    }
    .btn{background:var(--btn);color:#fff}
    .btn.alt{background:#fff;border:1px solid var(--btn);color:var(--btn)}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:8px 18px;
      border-radius:999px;
      border:1px solid #0002;
      background:#fff;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip.active{
      background:#0f766e;
      color:#fff;
      border-color:#0f766e;
    }
    .preview{display:grid;place-items:center;padding:10px}
    canvas{
      width:min(92%,520px);
      height:auto;
      max-height:78vh;
      aspect-ratio:2/3;
      display:block;
      background:transparent;
    }
    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      canvas{width:min(96%,560px)}
    }
    .hint{font-size:12px;opacity:.7;margin-top:-4px}
    .footer{padding:16px;text-align:center;opacity:.75}
  </style>
</head>
<body>
  <header>
    <h1 id="heading">幸運を味わう — 旅の安全と長寿を願って。</h1>
    <div class="sub" id="subtext">
      沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！
      <strong>#wagyu_blessing</strong>
    </div>
  </header>

  <main class="wrap">
    <!-- 左：操作エリア -->
    <section class="card panel">
      <div class="controls">
        <div class="row">
          <label for="lang" id="label-lang">Language</label>
          <select id="lang">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div class="row"><label for="name" id="label-name">お名前（任意）</label></div>
        <div class="row">
          <input id="name" type="text" maxlength="24" placeholder="Traveler" />
        </div>

        <div class="row"><label id="label-bg">背景カラー（SNS映え）</label></div>
        <div id="palette" class="stack" aria-label="背景カラー"></div>

        <div class="row" style="gap:8px">
          <button class="btn" id="make" type="button">願いを込めて お守りを作る</button>
          <button class="btn alt" id="save" type="button">PNGを保存</button>
          <button class="btn alt" id="share" type="button">シェアする</button>
        </div>

        <p class="hint">
          ※ お名前は保存しません。お守り画像の生成のみに使用します。
        </p>
      </div>
    </section>

    <!-- 右：プレビュー -->
    <section class="card preview">
      <canvas id="view" width="1200" height="1800" aria-label="お守りプレビュー"></canvas>
    </section>
  </main>

  <div class="footer">
    © Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>
  </div>

<script>
  // ===== DOM =====
  const canvas   = document.getElementById("view");
  const ctx      = canvas.getContext("2d");
  const langEl   = document.getElementById("lang");
  const nameEl   = document.getElementById("name");
  const makeBtn  = document.getElementById("make");
  const saveBtn  = document.getElementById("save");
  const shareBtn = document.getElementById("share");
  const paletteEl= document.getElementById("palette");

  const headingEl = document.getElementById("heading");
  const subEl     = document.getElementById("subtext");
  const labelLang = document.getElementById("label-lang");
  const labelName = document.getElementById("label-name");
  const labelBg   = document.getElementById("label-bg");
  const footerEl  = document.querySelector(".footer");

  let currentLang = langEl.value;        // "ja" / "en" / "zh"
  let currentBg   = "#10b7b0";           // 初期ターコイズ
  let baseLoaded  = false;

  let animId  = null;
  let petals  = [];

  // ===== ベース画像 =====
  const base = new Image();
  base.src = "omamori_base.png";
  base.onload = () => {
    baseLoaded = true;
    drawStatic();
  };

  // ===== キャンバス上のテキスト =====
  const I18N = {
    ja: {
      title: "旅のお守り",
      sub: "安全な旅路と長寿を祈って",
      traveler: "Traveler",
    },
    en: {
      title: "Travel Blessing Charm",
      sub:   "For Safe Journeys & Long Life",
      traveler: "Traveler",
    },
    zh: {
      title: "祈福护身符",
      sub:   "旅途平安 · 长命百岁",
      traveler: "Traveler",
    },
  };

  const LAYOUT = {
    ja: { titleY: 760, titleSize: 84, subY: 860, subSize: 42 },
    en: { titleY: 750, titleSize: 72, subY: 845, subSize: 38 },
    zh: { titleY: 750, titleSize: 80, subY: 850, subSize: 42 },
  };

  // ===== UI テキスト =====
  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelName:"お名前（任意）",
      labelBg:  "背景カラー（SNS映え）",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "シェアする",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelName:"Name (optional)",
      labelBg:  "Background color (for SNS)",
      btnMake:  "Create my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelName:"姓名（可选）",
      labelBg:  "背景颜色（适合 SNS）",
      btnMake:  "祈愿并生成护身符",
      btnSave:  "保存 PNG",
      btnShare: "分享",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
    },
  };

  // ===== 背景色候補 =====
  const BG_COLORS = [
    { key:"deep",        color:"#0b3b5a", labels:{ja:"深い藍",        en:"Deep Indigo",   zh:"深靛蓝"} },
    { key:"sakura",      color:"#f9c5cf", labels:{ja:"桜ピンク",      en:"Sakura Pink",   zh:"樱花粉"} },
    { key:"jade",        color:"#0f766e", labels:{ja:"翡翠グリーン",  en:"Jade Green",    zh:"翡翠绿"} },
    { key:"purple-gold", color:"#432f70", labels:{ja:"紫×金",         en:"Purple × Gold", zh:"紫×金"} },
    { key:"ryukyu-blue", color:"#0077b6", labels:{ja:"琉球ブルー",     en:"Ryukyu Blue",   zh:"琉球蓝"} },
    { key:"sunset",      color:"#f97316", labels:{ja:"サンセット",     en:"Sunset Orange", zh:"夕阳橙"} },
    { key:"turquoise",   color:"#10b7b0", labels:{ja:"ターコイズ",     en:"Turquoise",     zh:"绿松石色"} },
    { key:"golden-hour", color:"#fad643", labels:{ja:"ゴールデンアワー", en:"Golden Hour",  zh:"金色黄昏"} },
  ];

  // ===== UI適用 =====
  function applyUILanguage(){
    const t = UI_I18N[currentLang];
    headingEl.textContent = t.heading;
    subEl.innerHTML       = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelName.textContent = t.labelName;
    labelBg.textContent   = t.labelBg;
    makeBtn.textContent   = t.btnMake;
    saveBtn.textContent   = t.btnSave;
    shareBtn.textContent  = t.btnShare;
    footerEl.innerHTML    = t.footer;
  }

  function buildPalette(){
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (c.color === currentBg ? " active" : "");
      btn.dataset.color = c.color;
      btn.textContent = c.labels[currentLang];
      paletteEl.appendChild(btn);
    });
  }

  paletteEl.addEventListener("click", e=>{
    const target = e.target;
    if(!target.classList.contains("chip")) return;
    [...paletteEl.querySelectorAll(".chip")].forEach(b=>b.classList.remove("active"));
    target.classList.add("active");
    currentBg = target.dataset.color;
    drawStatic();
  });

  // ===== 描画ヘルパー =====
  function drawText(text, x, y, size, weight){
    ctx.save();
    ctx.font = `${weight} ${size}px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function drawBaseAndText(){
    const W = canvas.width;
    const H = canvas.height;
    ctx.drawImage(base, 0, 0, W, H);

    const langData = I18N[currentLang] || I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;
    const travelerName = (nameEl.value || "").trim() || langData.traveler;

    drawText(langData.title, W/2, layout.titleY, layout.titleSize, "700");
    drawText(langData.sub,   W/2, layout.subY,   layout.subSize,  "600");
    drawText(travelerName,   W/2, 1516, 100, "700");
    drawText("#wagyu_blessing", W/2, 1618, 50, "600");
  }

  function drawStatic(){
    if(!baseLoaded) return;
    const W = canvas.width;
    const H = canvas.height;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = currentBg;
    ctx.fillRect(0,0,W,H);
    drawBaseAndText();
  }

  // ===== 桜パーティクル =====
  function createPetals(){
    const W = canvas.width;
    const H = canvas.height;
    const list = [];
    const count = 120; // 花びらの数

    for(let i=0; i<count; i++){
      const delay = Math.random()*0.5; // 0〜0.5秒分くらい遅れて落ち始め

      const baseX = W/2 + (Math.random()*2-1)*W*0.45;
      const startY = -80 - Math.random()*120;
      const endY   = H + 90; // 画面の下より少し下

      list.push({
        baseX,
        startY,
        endY,
        swayAmp: 30 + Math.random()*40,
        swayFreq: 1.5 + Math.random()*2,
        swayPhase: Math.random()*Math.PI*2,
        rotSpeed: (Math.random()*2-1)*Math.PI*1.2,
        size: 6 + Math.random()*8,
        delay,          // 落ち始めの遅れ
        x: baseX,
        y: startY,
        angle: 0,
        alpha: 0,
      });
    }
    return list;
  }

  function updatePetals(globalT){
    const W = canvas.width;
    const H = canvas.height;

    petals.forEach(p=>{
      // まだスタート前なら非表示
      if(globalT < p.delay){
        p.alpha = 0;
        return;
      }

      // 0〜1 に正規化：globalT=1 のときは、必ず localT=1（＝全員ボトムまで到達）
      const localT = (globalT - p.delay) / (1 - p.delay);
      const fall   = Math.min(1, Math.max(0, localT));
      const eased  = Math.pow(fall, 1.1); // 少しだけゆっくり目の落ち方

      p.y = p.startY + (p.endY - p.startY)*eased;
      p.x = p.baseX + Math.sin(eased*p.swayFreq*Math.PI*2 + p.swayPhase)*p.swayAmp;
      p.angle = p.rotSpeed*eased;

      // 透明度：アニメ全体の進行(globalT)で管理
      // 0〜0.9 まではほぼ不透明、0.9〜1.0 でふわっと全員一緒に消える
      let alphaBase = 0.95;
      if(globalT <= 0.9){
        p.alpha = alphaBase;
      }else{
        const fadeT = (globalT - 0.9) / 0.1; // 0〜1
        const k = Math.min(1, Math.max(0, fadeT));
        p.alpha = alphaBase * Math.pow(1 - k, 1.5);
      }
    });
  }

  // ===== 1フレーム描画 =====
  function drawAnimationFrame(globalT){
    if(!baseLoaded) return;
    const W = canvas.width;
    const H = canvas.height;
    const cx = W/2;
    const cy = H/2;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = currentBg;
    ctx.fillRect(0,0,W,H);

    // ふわっとスケール
    const scale = 1 + 0.18*Math.sin(globalT*Math.PI); // 1→1.18→1

    // 強めのフラッシュ（序盤）
    if(globalT < 0.45){
      const k = 1 - globalT/0.45;
      ctx.save();
      ctx.globalAlpha = 0.85*k;
      ctx.fillStyle = "white";
      ctx.fillRect(0,0,W,H);
      ctx.restore();
    }

    // お守り本体＋文字
    ctx.save();
    ctx.translate(cx,cy);
    ctx.scale(scale,scale);
    ctx.translate(-cx,-cy);
    drawBaseAndText();
    ctx.restore();

    // 光のリング（菊の紋の周り）
    const ringP = Math.min(1, Math.max(0,(globalT-0.1)/0.7));
    if(ringP > 0){
      const ringCx = W/2;
      const ringCy = H*0.33;
      const baseR  = W*0.16;
      const r      = baseR + baseR*0.8*ringP;
      const alpha  = 0.9*(1-ringP);

      ctx.save();
      const grad = ctx.createRadialGradient(ringCx, ringCy, 0, ringCx, ringCy, r);
      grad.addColorStop(0,   "rgba(255,255,255,1)");
      grad.addColorStop(0.5, "rgba(255,255,255,0.7)");
      grad.addColorStop(1,   "rgba(255,255,255,0)");
      ctx.globalAlpha = alpha;
      ctx.strokeStyle = grad;
      ctx.lineWidth   = 22;
      ctx.beginPath();
      ctx.arc(ringCx, ringCy, r, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // 桜の描画
    if(petals.length){
      ctx.save();
      petals.forEach(p=>{
        if(p.alpha <= 0) return;
        ctx.globalAlpha = p.alpha;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        const w = p.size;
        const h = p.size*1.8;
        const grad = ctx.createLinearGradient(-w, -h/2, w, h/2);
        grad.addColorStop(0,   "rgba(255,255,255,0)");
        grad.addColorStop(0.35,"rgba(255,235,245,0.97)");
        grad.addColorStop(1,   "rgba(255,200,220,0.4)");
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.ellipse(0,0,w,h,0,0,Math.PI*2);
        ctx.fill();
        ctx.restore();
      });
      ctx.restore();
    }
  }

  // ===== アニメーション開始 =====
  function startBlessingAnimation(){
    if(!baseLoaded) return;

    if(animId !== null){
      cancelAnimationFrame(animId);
      animId = null;
    }

    petals = createPetals();
    const duration = 3200; // 全体 3.2 秒
    const start = performance.now();

    function frame(now){
      const t = Math.min(1, (now - start)/duration);
      updatePetals(t);
      drawAnimationFrame(t);

      if(t < 1){
        animId = requestAnimationFrame(frame);
      }else{
        animId = null;
        drawStatic(); // 最後は静止画へ
      }
    }
    animId = requestAnimationFrame(frame);
  }

  // ===== イベント =====
  makeBtn.addEventListener("click", startBlessingAnimation);

  langEl.addEventListener("change", ()=>{
    currentLang = langEl.value;
    applyUILanguage();
    buildPalette();
    drawStatic();
  });

  nameEl.addEventListener("input", drawStatic);

  saveBtn.addEventListener("click", ()=>{
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  shareBtn.addEventListener("click", ()=>{
    const tag = "#wagyu_blessing";
    if(navigator.share){
      navigator.share({ text: tag });
    }else if(navigator.clipboard){
      navigator.clipboard.writeText(tag);
      alert("ハッシュタグ " + tag + " をコピーしました。");
    }
  });

  // ===== 初期表示 =====
  applyUILanguage();
  buildPalette();
</script>
</body>
</html>
