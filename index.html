<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wagyu Blessing Amulet | #wagyu_blessing</title>
  <meta name="description" content="Create a Japanese Omamori-style blessing card for travelers.">
  <meta name="theme-color" content="#10b7b0" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{
      --bg: #10b7b0;
      --ink: #0f2b2e;
      --panel: #f5e7c4;
      --btn: #125a5a;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:#ece8d3;
    }
    header{padding:18px 22px}
    h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,36px)}
    .sub{opacity:.8}
    .wrap{
      display:grid;
      gap:20px;
      align-items:flex-start;
      grid-template-columns:minmax(280px,420px) 1fr;
      padding:0 22px 28px;
    }
    .card{
      background:#fffffff0;
      border:1px solid #0001;
      border-radius:16px;
      box-shadow:0 10px 24px #0001;
    }
    .panel{padding:16px;position:relative;z-index:1;}
    .controls .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    input,select,button{font-size:16px}
    input[type=text],select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #0002;
      box-sizing:border-box;
    }
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
    }
    .btn{background:var(--btn);color:#fff}
    .btn.alt{background:#fff;border:1px solid var(--btn);color:var(--btn)}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #0002;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-size:14px;
    }
    .chip.active{
      background:#0f766e;
      color:#fff;
      border-color:#0f766e;
    }
    .preview{display:grid;place-items:center;padding:10px}
    canvas{
      width:min(92%,520px);
      height:auto;
      max-height:78vh;
      aspect-ratio:2/3;
      display:block;
      background:transparent;
    }
    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      canvas{width:min(96%,560px)}
    }
    .hint{font-size:12px;opacity:.7;margin-top:-4px}
    .footer{padding:16px;text-align:center;opacity:.75}

    /* Lucky メーター */
    .lucky-box{
      margin-top:10px;
      padding:8px 10px;
      border-radius:12px;
      background:#fef9e6;
      border:1px solid #facc6b;
      font-size:13px;
      display:none;
    }
    .lucky-score{
      font-weight:700;
      margin-bottom:2px;
    }
    .lucky-text{
      font-size:12px;
    }

    /* Toast メッセージ */
    .toast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%) translateY(10px);
      background:rgba(0,0,0,.78);
      color:#fff;
      padding:8px 16px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .3s, transform .3s;
      z-index:50;
      white-space:nowrap;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1 id="heading">幸運を味わう — 旅の安全と長寿を願って。</h1>
    <div class="sub" id="subtext">
      沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！
      <strong>#wagyu_blessing</strong>
    </div>
  </header>

  <main class="wrap">
    <!-- 左：操作エリア -->
    <section class="card panel">
      <div class="controls">
        <div class="row">
          <label for="lang" id="label-lang">Language</label>
          <select id="lang">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div class="row">
          <label for="template" id="label-template">テンプレート</label>
        </div>
        <div class="row">
          <select id="template">
            <option value="shuri">Shuri Castle</option>
            <option value="ocean">Ocean & Sunset</option>
            <option value="flowers">Ryukyu Flowers</option>
            <option value="character">Character</option>
          </select>
        </div>

        <div class="row"><label for="name" id="label-name">お名前（任意）</label></div>
        <div class="row">
          <input id="name" type="text" maxlength="24" placeholder="Traveler" />
        </div>

        <div class="row">
          <label for="nameStyle" id="label-style">Name Style</label>
        </div>
        <div class="row">
          <select id="nameStyle">
            <option value="classic">Classic</option>
            <option value="hand">Handwritten</option>
            <option value="elegant">Elegant</option>
            <option value="bold">Bold</option>
            <option value="pop">Pop</option>
          </select>
        </div>

        <div class="row"><label id="label-bg">背景カラー（SNS映え）</label></div>
        <div id="palette" class="stack" aria-label="背景カラー"></div>

        <div class="row" style="gap:8px">
          <button class="btn" id="make" type="button">願いを込めて お守りを作る</button>
          <button class="btn alt" id="save" type="button">PNGを保存</button>
          <button class="btn alt" id="share" type="button">シェアする</button>
        </div>

        <div id="lucky-box" class="lucky-box">
          <div id="lucky-score" class="lucky-score"></div>
          <div id="lucky-text" class="lucky-text"></div>
        </div>
      
      </div>
    </section>

    <!-- 右：プレビュー -->
    <section class="card preview">
      <canvas id="view" width="1200" height="1800" aria-label="お守りプレビュー"></canvas>
    </section>
  </main>

  <div class="footer">
    © Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>
  </div>

  <div id="toast" class="toast"></div>

<script>
  // ===== DOM 取得 =====
  const canvas   = document.getElementById("view");
  const ctx      = canvas.getContext("2d");
  const langEl   = document.getElementById("lang");
  const nameEl   = document.getElementById("name");
  const makeBtn  = document.getElementById("make");
  const saveBtn  = document.getElementById("save");
  const shareBtn = document.getElementById("share");
  const paletteEl= document.getElementById("palette");
  const templateEl = document.getElementById("template");
  const nameStyleEl = document.getElementById("nameStyle");

  const headingEl = document.getElementById("heading");
  const subEl     = document.getElementById("subtext");
  const labelLang = document.getElementById("label-lang");
  const labelName = document.getElementById("label-name");
  const labelBg   = document.getElementById("label-bg");
  const labelTemplate = document.getElementById("label-template");
  const labelStyle    = document.getElementById("label-style");
  const footerEl  = document.querySelector(".footer");

  const luckyBox    = document.getElementById("lucky-box");
  const luckyScoreEl= document.getElementById("lucky-score");
  const luckyTextEl = document.getElementById("lucky-text");
  const toastEl     = document.getElementById("toast");

  // ===== グローバル状態 =====
  let currentLang   = langEl.value || "ja";
  let currentBg     = "#10b7b0";           // 初期ターコイズ
  let currentTemplate = "shuri";
  let currentNameStyle = "classic";

  // ===== 文字なしお守り画像 =====
  const base = new Image();
  let baseLoaded = false;

  base.onload = () => {
    baseLoaded = true;
    draw();
  };

  const TEMPLATE_SRC = {
    shuri: "omamori_base.png",
    ocean: "omamori_base_ocean.png",
    flowers: "omamori_base_flowers.png",
    character: "omamori_base_character.png",
  };

  const TEMPLATE_I18N = {
    shuri: {
      ja: "首里城",
      en: "Shuri Castle",
      zh: "首里城",
    },
    ocean: {
      ja: "海とサンセット",
      en: "Ocean & Sunset",
      zh: "海与夕阳",
    },
    flowers: {
      ja: "琉球の花",
      en: "Ryukyu Flowers",
      zh: "琉球之花",
    },
    character: {
      ja: "キャラクター",
      en: "Character",
      zh: "角色",
    },
  };

  function setTemplate(tplKey){
    const src = TEMPLATE_SRC[tplKey] || TEMPLATE_SRC.shuri;
    baseLoaded = false;
    base.src = src;
  }

  // ===== キャンバス上の文言 =====
  const I18N = {
    ja: {
      title: "旅のお守り",
      sub: "安全な旅路と長寿を祈って",
      traveler: "沖縄 花子",
    },
    en: {
      title: "Travel Blessing Charm",
      sub:   "For Safe Journeys & Long Life",
      traveler: "Traveler",
    },
    zh: {
      title: "祈福护身符",
      sub:   "旅途平安 · 长命百岁",
      traveler: "旅人",
    },
  };

  // ===== UI の文言 =====
  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelName:"お名前（任意）",
      labelBg:  "背景カラー",
      labelTemplate: "テンプレート",
      labelStyle: "名前フォント",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "シェアする",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelName:"Name (optional)",
      labelBg:  "Background color",
      labelTemplate: "Template",
      labelStyle: "Name Style",
      btnMake:  "Create my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelName:"姓名（可选）",
      labelBg:  "背景颜色",
      labelTemplate: "模板",
      labelStyle: "名字字体风格",
      btnMake:  "祈愿并生成护身符",
      btnSave:  "保存 PNG",
      btnShare: "分享",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
    },
  };

  // ===== 背景色候補 =====
  const BG_COLORS = [
    {
      key: "deep",
      color: "#0b3b5a",
      labels: { ja: "深い藍", en: "Deep Indigo", zh: "深靛蓝" },
    },
    {
      key: "sakura",
      color: "#f9c5cf",
      labels: { ja: "桜ピンク", en: "Sakura Pink", zh: "樱花粉" },
    },
    {
      key: "jade",
      color: "#0f766e",
      labels: { ja: "翡翠グリーン", en: "Jade Green", zh: "翡翠绿" },
    },
    {
      key: "purple-gold",
      color: "#432f70",
      labels: { ja: "紫×金", en: "Purple × Gold", zh: "紫×金" },
    },
    {
      key: "ryukyu-blue",
      color: "#0077b6",
      labels: { ja: "琉球ブルー", en: "Ryukyu Blue", zh: "琉球蓝" },
    },
    {
      key: "sunset",
      color: "#f97316",
      labels: { ja: "サンセット", en: "Sunset Orange", zh: "夕阳橙" },
    },
    {
      key: "turquoise",
      color: "#10b7b0",
      labels: { ja: "ターコイズ", en: "Turquoise", zh: "绿松石色" },
    },
  ];

 // ===== 名前フォントスタイル =====
const NAME_FONTS = {
  // 落ち着いた明朝系
  classic: '"Noto Serif JP", "Yu Mincho", "Hiragino Mincho ProN", serif',
  // ラフな手書き風
  hand: '"Comic Sans MS", "Bradley Hand", "Hachi Maru Pop", cursive, system-ui',
  // 細めで上品
  elegant: '"Georgia", "Times New Roman", "Noto Serif JP", serif',
  // しっかり太めのゴシック
  bold: '"Noto Sans JP", "Yu Gothic", "Hiragino Kaku Gothic ProN", sans-serif',
  // ちょっと丸みのあるポップ系
  pop: '"Trebuchet MS", "Rounded Mplus 1c", "Noto Sans JP", system-ui, sans-serif',
};

  const NAME_STYLE_I18N = {
    classic: {
      ja: "クラシック",
      en: "Classic",
      zh: "经典",
    },
    hand: {
      ja: "手書き風",
      en: "Handwritten",
      zh: "手写风",
    },
    elegant: {
      ja: "エレガント",
      en: "Elegant",
      zh: "优雅",
    },
    bold: {
      ja: "ボールド",
      en: "Bold",
      zh: "粗体",
    },
    pop: {
      ja: "ポップ",
      en: "Pop",
      zh: "流行风",
    },
  };

  // ===== キャンバス上レイアウト（言語別） =====
  const LAYOUT = {
    ja: {
      titleY: 750,
      titleSize: 90,
      subY: 840,
      subSize: 46,
      nameY: 1516,
      nameSize: 100,
      hashY: 1618,
      hashSize: 50,
    },
    en: {
      titleY: 730,
      titleSize: 78,
      subY: 820,
      subSize: 40,
      nameY: 1516,
      nameSize: 96,
      hashY: 1618,
      hashSize: 48,
    },
    zh: {
      titleY: 750,
      titleSize: 86,
      subY: 840,
      subSize: 46,
      nameY: 1516,
      nameSize: 100,
      hashY: 1618,
      hashSize: 50,
    },
  };

  // ===== ラッキー度メッセージ =====
  const LUCKY_MESSAGES = {
    ja: [
      { score: "Wagyu Luck: 96% ★★★★★", text: "今日は新しい冒険にぴったりの日です。" },
      { score: "Wagyu Luck: 88% ★★★★☆", text: "ゆったり旅を楽しむのに最高のコンディション。" },
      { score: "Wagyu Luck: 78% ★★★☆☆", text: "落ち着いた旅路。小さなラッキーを探してみて。" },
      { score: "Calm Sea, Safe Journey: 82%", text: "波も心もおだやか。安全第一で楽しみましょう。" },
    ],
    en: [
      { score: "Wagyu Luck: 92% ★★★★★", text: "Perfect for new adventures today." },
      { score: "Wagyu Luck: 84% ★★★★☆", text: "Great day to explore and try something new." },
      { score: "Calm Sea, Safe Journey: 78%", text: "Gentle vibes for a relaxed, safe trip." },
      { score: "Wagyu Luck: 65% ★★★☆☆", text: "Take it slow and enjoy the little moments." },
    ],
    zh: [
      { score: "和牛幸运值：93% ★★★★★", text: "今天非常适合开启新的旅程。" },
      { score: "和牛幸运值：85% ★★★★☆", text: "悠闲出行的好日子，记得多拍几张照片。" },
      { score: "平安指数：80%", text: "心情平静，旅途顺利，适合慢慢享受。" },
      { score: "和牛幸运值：70% ★★★☆☆", text: "放慢脚步，小小的惊喜正在等你。" },
    ],
  };

  // ===== トーストメッセージ =====
  const TOAST_MESSAGES = {
    ja: "✨お守りに願いを込めました ✨",
    en: "✨ Your wish has been sent to the omamori ✨",
    zh: "✨ 已把你的心愿注入御守 ✨",
  };

  // ===== UIテキストを反映 =====
  function applyUILanguage() {
    const t = UI_I18N[currentLang];

    headingEl.textContent = t.heading;
    subEl.innerHTML       = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelName.textContent = t.labelName;
    labelBg.textContent   = t.labelBg;
    labelTemplate.textContent = t.labelTemplate;
    labelStyle.textContent    = t.labelStyle;
    makeBtn.textContent   = t.btnMake;
    saveBtn.textContent   = t.btnSave;
    shareBtn.textContent  = t.btnShare;
    footerEl.innerHTML    = t.footer;

    buildTemplateOptions();
    buildNameStyleOptions();
  }

  // ===== テンプレートの選択肢を再構成 =====
  function buildTemplateOptions() {
    const order = ["shuri","ocean","flowers","character"];
    templateEl.innerHTML = "";
    order.forEach(key => {
      const opt = document.createElement("option");
      opt.value = key;
      const labels = TEMPLATE_I18N[key];
      opt.textContent = labels ? labels[currentLang] : key;
      if (key === currentTemplate) opt.selected = true;
      templateEl.appendChild(opt);
    });
  }

  // ===== Name Style の選択肢を再構成 =====
  function buildNameStyleOptions() {
    const order = ["classic","hand","elegant","bold","pop"];
    nameStyleEl.innerHTML = "";
    order.forEach(key => {
      const opt = document.createElement("option");
      opt.value = key;
      const labels = NAME_STYLE_I18N[key];
      opt.textContent = labels ? labels[currentLang] : key;
      if (key === currentNameStyle) opt.selected = true;
      nameStyleEl.appendChild(opt);
    });
  }

  // ===== 背景色ボタンを描き直す =====
  function buildPalette() {
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (c.color === currentBg ? " active" : "");
      btn.dataset.color = c.color;
      btn.dataset.key   = c.key;
      btn.textContent   = c.labels[currentLang];
      btn.style.background = c.color;
      btn.style.color = "#fff";
      paletteEl.appendChild(btn);
    });
  }

  // 背景色ボタンクリック
  paletteEl.addEventListener("click", (e) => {
    const target = e.target;
    if (!target.classList.contains("chip")) return;

    [...paletteEl.querySelectorAll(".chip")].forEach(b => b.classList.remove("active"));
    target.classList.add("active");

    currentBg = target.dataset.color;
    draw();
  });

  // ===== キャンバスに文字を描くヘルパー =====
  function drawText(text, x, y, size, weight, fontOverride) {
    ctx.save();
    const family = fontOverride || '"Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif';
    ctx.font = `${weight} ${size}px ${family}`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  // ===== メイン描画 =====
  function draw(scale = 1) {
    if (!baseLoaded) return;

    const W = canvas.width;
    const H = canvas.height;

    const langData = I18N[currentLang] || I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;
    const travelerName = (nameEl.value || "").trim() || langData.traveler;

    // 背景色
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = currentBg;
    ctx.fillRect(0, 0, W, H);

    const cx = W / 2;
    const cy = H / 2;

    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(scale, scale);
    ctx.translate(-cx, -cy);

    // お守り画像
    ctx.drawImage(base, 0, 0, W, H);

    // タイトル
    drawText(langData.title, W / 2, layout.titleY, layout.titleSize, "700");
    // サブタイトル
    drawText(langData.sub,   W / 2, layout.subY,   layout.subSize,   "600");
    // Traveler（名前）
    const nameFontFamily = NAME_FONTS[currentNameStyle] || NAME_FONTS.classic;
    drawText(travelerName,  W / 2, layout.nameY,  layout.nameSize,  "700", nameFontFamily);
    // ハッシュタグ
    drawText("#wagyu_blessing", W / 2, layout.hashY, layout.hashSize, "600");

    ctx.restore();
  }

  // ===== 桜の花びらアニメ用 =====
  function createPetals(count, duration, H) {
    const petals = [];
    for (let i = 0; i < count; i++) {
      const delay = Math.random() * 400; // 少しずつ遅れて落ち始める
      petals.push({
        delay,
        x: Math.random() * canvas.width,
        yStart: -120 - Math.random() * 200,
        yEnd: H + 120,
        swing: 60 + Math.random() * 60,          // 左右に大きくふわふわ
        phase: Math.random() * Math.PI * 2,
        omega: 0.6 + Math.random() * 0.8,        // ゆっくり揺れる
        rotation: Math.random() * Math.PI * 2,
        rotationSpeed: (Math.random() * 2 - 1) * 0.04,
        scale: 0.5 + Math.random() * 0.7,
      });
    }
    return petals;
  }

  function drawPetals(elapsed, duration, petals) {
    const W = canvas.width;
    const H = canvas.height;

    ctx.save();
    petals.forEach(petal => {
      const localT = elapsed - petal.delay;
      if (localT <= 0) return;

      const life = duration - petal.delay;
      const k = Math.min(localT / life, 1); // 0〜1

      const y = petal.yStart + (petal.yEnd - petal.yStart) * k;
      const x = petal.x + Math.sin(petal.phase + petal.omega * k * 4) * petal.swing;

      let alpha = 0.9;
      if (k > 0.85) {
        alpha = 0.9 * (1 - (k - 0.85) / 0.15); // 最後の15%でふわっと消える
      }

      const size = 18 * petal.scale;

      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(petal.rotation + petal.rotationSpeed * (localT / 16));
      ctx.globalAlpha = alpha;

      ctx.fillStyle = "#ffe4f2";
      ctx.beginPath();
      ctx.moveTo(0, -size * 0.6);
      ctx.quadraticCurveTo(size * 0.5, -size * 0.2, 0, size * 0.8);
      ctx.quadraticCurveTo(-size * 0.5, -size * 0.2, 0, -size * 0.6);
      ctx.fill();

      ctx.restore();
    });
    ctx.restore();
    ctx.globalAlpha = 1;
  }

  // ===== アニメーション（ふわっと拡大＋光リング＋桜） =====
  function triggerOmamoriAnimation() {
    if (!baseLoaded) return;

    const duration = 3000; // 少し長めにして、ゆっくり落ちる
    const start = performance.now();
    const petals = createPetals(90, duration, canvas.height);

    function frame(now) {
      const elapsed = now - start;
      const p = Math.min(elapsed / duration, 1);

      const pulsePhase = Math.min(p / 0.4, 1);
      const scale = 1 + 0.10 * Math.sin(pulsePhase * Math.PI);

      draw(scale);

      const W = canvas.width;
      const H = canvas.height;

      // 光のリング（少し上寄り＝菊花紋章あたりから）
      if (p < 0.55) {
        const ringP = p / 0.55;
        const maxR = W * 0.65;
        const r = ringP * maxR;
        const alpha = 0.9 * (1 - ringP);

        ctx.save();
        ctx.beginPath();
        ctx.arc(W / 2, H * 0.27, r, 0, Math.PI * 2); // ここを少し上に
        ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
        ctx.lineWidth = 12 * (1 - ringP) + 3;
        ctx.stroke();
        ctx.restore();
      }

      // 桜吹雪
      drawPetals(elapsed, duration, petals);

      if (p < 1) {
        requestAnimationFrame(frame);
      } else {
        draw(); // 最終状態で静止
      }
    }

    requestAnimationFrame(frame);
  }

  // ===== Lucky メッセージ更新 =====
  function updateLuckyMessage() {
    const pool = LUCKY_MESSAGES[currentLang] || LUCKY_MESSAGES.ja;
    const pick = pool[Math.floor(Math.random() * pool.length)];
    luckyScoreEl.textContent = pick.score;
    luckyTextEl.textContent  = pick.text;
    luckyBox.style.display   = "block";
  }

  // ===== Toast 表示 =====
  function showToast(message) {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.classList.add("show");
    setTimeout(() => {
      toastEl.classList.remove("show");
    }, 1600);
  }

  // ===== URL へ状態を保存する用 =====
  function buildShareURL() {
    const params = new URLSearchParams();
    params.set("lang", currentLang);
    params.set("bg", currentBg);
    params.set("tpl", currentTemplate);
    params.set("style", currentNameStyle);
    if (nameEl.value.trim()) {
      params.set("name", nameEl.value.trim());
    }
    return `${location.origin}${location.pathname}?${params.toString()}`;
  }

  // ===== URL から状態を復元 =====
  function applyStateFromURL() {
    const params = new URLSearchParams(location.search);

    const lang = params.get("lang");
    const bgParam = params.get("bg");
    const tpl = params.get("tpl");
    const style = params.get("style");
    const name = params.get("name");

    if (lang && I18N[lang]) {
      currentLang = lang;
      langEl.value = lang;
    }

    if (bgParam) {
      let match =
        BG_COLORS.find(c => c.key === bgParam) ||
        BG_COLORS.find(c => c.color.toLowerCase() === bgParam.toLowerCase());
      if (match) {
        currentBg = match.color;
      }
    }

    if (tpl && TEMPLATE_SRC[tpl]) {
      currentTemplate = tpl;
    }
    templateEl.value = currentTemplate;

    if (style && NAME_FONTS[style]) {
      currentNameStyle = style;
    }
    nameStyleEl.value = currentNameStyle;

    if (name) {
      nameEl.value = name;
    }

    setTemplate(currentTemplate);
  }

  // ===== イベント設定 =====
  makeBtn.addEventListener("click", () => {
    draw();
    triggerOmamoriAnimation();
    updateLuckyMessage();
    const msg = TOAST_MESSAGES[currentLang] || TOAST_MESSAGES.ja;
    showToast(msg);
  });

  langEl.addEventListener("change", () => {
    currentLang = langEl.value;
    applyUILanguage();
    buildPalette();
    draw();
  });

  nameEl.addEventListener("input", () => {
    draw();
  });

  templateEl.addEventListener("change", () => {
    currentTemplate = templateEl.value;
    setTemplate(currentTemplate);
  });

  nameStyleEl.addEventListener("change", () => {
    currentNameStyle = nameStyleEl.value;
    draw();
  });

  // PNG保存
  saveBtn.addEventListener("click", () => {
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  // シェア
  shareBtn.addEventListener("click", () => {
    const url = buildShareURL();
    const text = "#wagyu_blessing";
    if (navigator.share) {
      navigator.share({ url, text });
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(url);
      alert("このお守りのURLをコピーしました:\n" + url);
    } else {
      prompt("このURLをコピーしてください", url);
    }
  });

  // ===== 初期表示 =====
  applyStateFromURL();
  applyUILanguage();
  buildPalette();

  // PWA: Service Worker 登録
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js").catch((err) => {
        console.log("ServiceWorker registration failed:", err);
      });
    });
  }
</script>
</body>
</html>
