<!DOCTYPE html>
<html lang="ja">
<head>
  <head>
  <!-- もともとの meta / title / style などはそのまま残す -->

  <!-- PWA 用 manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- ブラウザのアドレスバー／ステータスバーの色 -->
  <meta name="theme-color" content="#0b3b5a">

  <!-- スマホ／タブレット用アイコン（任意） -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/wagyu-icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/wagyu-icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/wagyu-icon-512.png">
</head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wagyu Blessing Amulet | #wagyu_blessing</title>
  <meta name="description" content="Create a Japanese Omamori-style blessing card for travelers.">
  <style>
    :root{
      --bg: #10b7b0;
      --ink: #0f2b2e;
      --panel: #f5e7c4;
      --btn: #125a5a;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:#ece8d3;
    }
    header{padding:18px 22px}
    h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,36px)}
    .sub{opacity:.8}
    .wrap{
      display:grid;
      gap:20px;
      align-items:flex-start;
      grid-template-columns:minmax(280px,420px) 1fr;
      padding:0 22px 28px;
    }
    .card{
      background:#fffffff0;
      border:1px solid #0001;
      border-radius:16px;
      box-shadow:0 10px 24px #0001;
    }
    .panel{padding:16px;position:relative;z-index:1;}
    .controls .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    input,select,button{font-size:16px}
    input[type=text],select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #0002;
    }
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
    }
    .btn{background:var(--btn);color:#fff}
    .btn.alt{background:#fff;border:1px solid var(--btn);color:var(--btn)}
    .stack{display:flex;flex-wrap:wrap;gap:10px}

    .chip{
      padding:8px 14px;
      border-radius:999px;
      border:2px solid transparent;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .chip.active{
      box-shadow:0 0 0 3px #0f766e40;
      border-color:#0f766e;
      transform:translateY(-1px);
    }

    .preview{display:grid;place-items:center;padding:10px}
    canvas{
      width:min(92%,520px);
      height:auto;
      max-height:78vh;
      aspect-ratio:2/3;
      display:block;
      background:transparent;
    }
    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      canvas{width:min(96%,560px)}
    }
    .hint{font-size:12px;opacity:.7;margin-top:-4px}
    .footer{padding:16px;text-align:center;opacity:.75;font-size:12px}

    .lucky{
      margin-top:6px;
      font-size:13px;
      opacity:.9;
    }
    .lucky strong{
      font-size:15px;
      margin-right:4px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%) translateY(8px);
      background:rgba(0,0,0,0.82);
      color:#fff;
      padding:8px 16px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      z-index:50;
      white-space:nowrap;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1 id="heading">幸運を味わう — 旅の安全と長寿を願って。</h1>
    <div class="sub" id="subtext">
      沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！
      <strong>#wagyu_blessing</strong>
    </div>
  </header>

  <main class="wrap">
    <!-- 左：操作エリア -->
    <section class="card panel">
      <div class="controls">
        <div class="row">
          <label for="lang" id="label-lang">Language</label>
          <select id="lang">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div class="row">
          <label for="name" id="label-name">お名前（任意）</label>
        </div>
        <div class="row">
          <input id="name" type="text" maxlength="24" placeholder="Traveler" />
        </div>

        <div class="row">
          <label for="nameStyle" id="label-nameStyle">名前スタイル</label>
          <select id="nameStyle">
            <option value="classic">Classic</option>
            <option value="hand">Handwritten</option>
            <option value="elegant">Elegant</option>
          </select>
        </div>

        <div class="row">
          <label for="template" id="label-template">Template</label>
          <select id="template"></select>
        </div>

        <div class="row"><label id="label-bg">背景カラー（SNS映え）</label></div>
        <div id="palette" class="stack" aria-label="背景カラー"></div>

        <div class="row" style="gap:8px">
          <button class="btn" id="make" type="button">願いを込めて お守りを作る</button>
          <button class="btn alt" id="save" type="button">PNGを保存</button>
          <button class="btn alt" id="share" type="button">リンクをシェア</button>
        </div>

        <p class="hint">
          ※ お名前は保存しません。お守り画像の生成のみに使用します。
        </p>

        <div id="luckyArea" class="lucky"></div>
      </div>
    </section>

    <!-- 右：プレビュー -->
    <section class="card preview">
      <canvas id="view" width="1200" height="1800" aria-label="お守りプレビュー"></canvas>
    </section>
  </main>

  <div class="footer">
    © Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>
  </div>

  <div id="toast" class="toast"></div>

<script>
  // ===== DOM 取得 =====
  const canvas     = document.getElementById("view");
  const ctx        = canvas.getContext("2d");
  const langEl     = document.getElementById("lang");
  const nameEl     = document.getElementById("name");
  const nameStyleEl= document.getElementById("nameStyle");
  const templateEl = document.getElementById("template");
  const makeBtn    = document.getElementById("make");
  const saveBtn    = document.getElementById("save");
  const shareBtn   = document.getElementById("share");
  const paletteEl  = document.getElementById("palette");
  const luckyEl    = document.getElementById("luckyArea");
  const toastEl    = document.getElementById("toast");

  const headingEl  = document.getElementById("heading");
  const subEl      = document.getElementById("subtext");
  const labelLang  = document.getElementById("label-lang");
  const labelName  = document.getElementById("label-name");
  const labelNameStyle = document.getElementById("label-nameStyle");
  const labelTpl   = document.getElementById("label-template");
  const labelBg    = document.getElementById("label-bg");
  const footerEl   = document.querySelector(".footer");

  // ===== グローバル状態 =====
  let currentLang      = "ja";       // ja | en | zh
  let currentBgKey     = "turquoise";
  let currentTemplate  = "shuri";    // shuri | ocean | flowers | character
  let currentNameStyle = "classic";

  let petals = [];
  let animId = null;
  let animStart = 0;
  let lastTime = 0;
  const ANIM_DURATION = 1600; // ms

  // ===== キャンバス上の文言 =====
  const CANVAS_TEXT = {
    ja: {
      title: "旅のお守り",
      sub: "安全な旅路と長寿を祈って",
      traveler: "Traveler",
    },
    en: {
      title: "Travel Blessing Charm",
      sub:   "For Safe Journeys & Long Life",
      traveler: "Traveler",
    },
    zh: {
      title: "祈福护身符",
      sub:   "旅途平安 · 长命百岁",
      traveler: "Traveler",
    },
  };

  // タイトル・サブのフォントサイズ（言語別）
  const TITLE_SIZES = {
    ja: 88,
    en: 72,
    zh: 82,
  };
  const SUB_SIZES = {
    ja: 42,
    en: 36,
    zh: 40,
  };

  // 名前用フォントスタイル
  const NAME_FONTS = {
    classic: '"Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif',
    hand: '"Comic Neue", "Patrick Hand", system-ui, -apple-system, "Segoe UI", sans-serif',
    elegant: '"Playfair Display", "Times New Roman", "Noto Serif JP", serif',
  };
  const NAME_SIZE = {
    ja: 100,
    en: 96,
    zh: 96,
  };

  // ===== UI の文言 =====
  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelName:"お名前（任意）",
      labelNameStyle:"名前スタイル",
      labelTpl: "テンプレート",
      labelBg:  "背景カラー（SNS映え）",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "リンクをシェア",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      nameStyles: {
        classic: "クラシック",
        hand: "手書き風",
        elegant: "エレガント",
      },
      toast: "✨ お守りに願いを込めました ✨",
      shareCopied: "リンクをコピーしました！",
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelName:"Name (optional)",
      labelNameStyle:"Name style",
      labelTpl: "Template",
      labelBg:  "Background color (for SNS)",
      btnMake:  "Bless my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share link",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      nameStyles: {
        classic: "Classic",
        hand: "Handwritten",
        elegant: "Elegant",
      },
      toast: "✨ Your wish has been blessed ✨",
      shareCopied: "Link copied!",
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelName:"姓名（可选）",
      labelNameStyle:"字体风格",
      labelTpl: "模板",
      labelBg:  "背景颜色（适合 SNS）",
      btnMake:  "注入祈愿，生成护身符",
      btnSave:  "保存 PNG",
      btnShare: "分享链接",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
      nameStyles: {
        classic: "经典",
        hand: "手写风",
        elegant: "优雅",
      },
      toast: "✨ 你的愿望已注入护身符 ✨",
      shareCopied: "链接已复制！",
    },
  };

  // ラッキー度メッセージ
  const LUCKY_MESSAGES = {
    ja: [
      { stars: "★★★★★", text: "和牛パワー全開！新しい旅にぴったりの一日です。" },
      { stars: "★★★★☆", text: "Wagyu Luck 92％。行き先を増やしても安心な運気です。" },
      { stars: "★★★☆☆", text: "Calm Sea, Safe Journey。ゆったり旅に最適な日です。" },
    ],
    en: [
      { stars: "★★★★★", text: "Wagyu Luck: 96% – Perfect for new adventures." },
      { stars: "★★★★☆", text: "Wagyu Luck: 88% – Today is a great day to travel." },
      { stars: "★★★☆☆", text: "Calm Sea, Safe Journey: 78% – Take it slow and enjoy." },
    ],
    zh: [
      { stars: "★★★★★", text: "和牛幸运：95% —— 适合开启全新的旅程。" },
      { stars: "★★★★☆", text: "今日旅运良好，适合多走几步、多看一点。" },
      { stars: "★★★☆☆", text: "海面平静 · 旅途平安：78%。慢慢享受今天吧。" },
    ],
  };

  // ===== 背景色候補 =====
  const BG_COLORS = [
    {
      key: "deep",
      color: "#0b3b5a",
      labels: { ja: "深い藍", en: "Deep Indigo", zh: "深靛蓝" },
    },
    {
      key: "sakura",
      color: "#f9c5cf",
      labels: { ja: "桜ピンク", en: "Sakura Pink", zh: "樱花粉" },
    },
    {
      key: "jade",
      color: "#0f766e",
      labels: { ja: "翡翠グリーン", en: "Jade Green", zh: "翡翠绿" },
    },
    {
      key: "purple-gold",
      color: "#432f70",
      labels: { ja: "紫×金", en: "Purple × Gold", zh: "紫×金" },
    },
    {
      key: "ryukyu-blue",
      color: "#0077b6",
      labels: { ja: "琉球ブルー", en: "Ryukyu Blue", zh: "琉球蓝" },
    },
    {
      key: "sunset",
      color: "#f97316",
      labels: { ja: "サンセット", en: "Sunset Orange", zh: "夕阳橙" },
    },
    {
      key: "turquoise",
      color: "#10b7b0",
      labels: { ja: "ターコイズ", en: "Turquoise", zh: "绿松石色" },
    },
  ];

  // ===== テンプレート（お守り画像） =====
  const TEMPLATES = {
    shuri: {
      src: "omamori_base.png",
      label: { ja: "首里城", en: "Shuri Castle", zh: "首里城" },
    },
    ocean: {
      src: "omamori_base_ocean.png",
      label: { ja: "サンセットビーチ", en: "Sunset Beach", zh: "海滩日落" },
    },
    flowers: {
      src: "omamori_base_flowers.png",
      label: { ja: "琉球の花", en: "Ryukyu Flowers", zh: "琉球之花" },
    },
    character: {
      src: "omamori_base_character.png",
      label: { ja: "キャラクター", en: "Character", zh: "角色护身符" },
    },
  };

  // テキスト位置（テンプレートごと）
  const LAYOUT = {
    // W=1200, H=1800 前提
    shuri:    { titleY: 750, subY: 840, travelerY: 1510, hashY: 1615 },
    ocean:    { titleY: 750, subY: 840, travelerY: 1510, hashY: 1615 },
    flowers:  { titleY: 750, subY: 840, travelerY: 1510, hashY: 1615 },
    // キャラクターは帽子にかぶらないよう、やや上に
    character:{ titleY: 680, subY: 770, travelerY: 1510, hashY: 1615 },
  };

  // ===== お守り画像の読み込み =====
  const baseImages = {};
  Object.entries(TEMPLATES).forEach(([key, info]) => {
    const img = new Image();
    img.src = info.src;
    img.onload = () => { img.ready = true; if (key === currentTemplate) draw(); };
    baseImages[key] = img;
  });

  // ===== ヘルパー =====
  function getBgConfig(){
    return BG_COLORS.find(c => c.key === currentBgKey) || BG_COLORS[0];
  }

  function getContrastColor(hex){
    const c = hex.replace("#","");
    const r = parseInt(c.substr(0,2),16);
    const g = parseInt(c.substr(2,2),16);
    const b = parseInt(c.substr(4,2),16);
    const yiq = (r*299 + g*587 + b*114)/1000;
    return yiq >= 140 ? "#111" : "#fff";
  }

  function drawText(text, x, y, size, weight){
    ctx.font = `${weight} ${size}px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
  }

  function drawNameText(text, x, y){
    const fam = NAME_FONTS[currentNameStyle] || NAME_FONTS.classic;
    const size = NAME_SIZE[currentLang] || NAME_SIZE.en;
    ctx.font = `700 ${size}px ${fam}`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
  }

  // ===== UIテキストを反映 =====
  function applyUILanguage(){
    const t = UI_I18N[currentLang];

    headingEl.textContent = t.heading;
    subEl.innerHTML = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelName.textContent = t.labelName;
    labelNameStyle.textContent = t.labelNameStyle;
    labelTpl.textContent = t.labelTpl;
    labelBg.textContent = t.labelBg;
    makeBtn.textContent = t.btnMake;
    saveBtn.textContent = t.btnSave;
    shareBtn.textContent = t.btnShare;
    footerEl.innerHTML = t.footer;

    // 名前スタイルのオプション
    Array.from(nameStyleEl.options).forEach(opt => {
      const key = opt.value;
      opt.textContent = t.nameStyles[key];
    });
  }

  // テンプレート選択肢を反映
  function buildTemplateOptions(){
    templateEl.innerHTML = "";
    Object.entries(TEMPLATES).forEach(([key, info]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = info.label[currentLang];
      if (key === currentTemplate) opt.selected = true;
      templateEl.appendChild(opt);
    });
  }

  // 背景色ボタンを描き直す
  function buildPalette(){
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (c.key === currentBgKey ? " active" : "");
      btn.dataset.key = c.key;
      btn.style.backgroundColor = c.color;
      btn.style.color = getContrastColor(c.color);
      btn.textContent = c.labels[currentLang];
      paletteEl.appendChild(btn);
    });
  }

  paletteEl.addEventListener("click", (e) => {
    const target = e.target;
    if (!target.classList.contains("chip")) return;
    const key = target.dataset.key;
    if (!key) return;
    currentBgKey = key;
    Array.from(paletteEl.querySelectorAll(".chip")).forEach(b => b.classList.remove("active"));
    target.classList.add("active");
    draw();
  });

  // ===== 桜の花びらアニメーション =====
  function createPetals(){
    petals = [];
    const W = canvas.width;
    const H = canvas.height;
    const count = 70; // たっぷりめ

    for (let i = 0; i < count; i++){
      petals.push({
        x: Math.random() * W,
        y: -Math.random() * H * 0.4,
        size: 18 + Math.random() * 14,
        speedY: 120 + Math.random() * 80,  // px / s
        drift: 40 + Math.random() * 50,
        offset: Math.random() * Math.PI * 2,
        rot: Math.random() * Math.PI * 2,
        rotSpeed: (Math.random() - 0.5) * 1.2,
      });
    }
  }

  function updatePetals(dt){
    const H = canvas.height;
    petals.forEach(p => {
      p.y += p.speedY * dt;
      p.x += Math.sin(p.offset + p.y / 90) * p.drift * dt;
      p.rot += p.rotSpeed * dt;
    });
    // 下まで来たら少しだけ下でフェードアウトさせるイメージ（今は単純に通過させる）
    petals = petals.filter(p => p.y < H + 40);
  }

  function drawPetals(){
    const H = canvas.height;
    ctx.save();
    petals.forEach(p => {
      if (p.y < -40 || p.y > H + 40) return;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      const w = p.size;
      const h = p.size * 0.6;
      const grad = ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
      grad.addColorStop(0, "rgba(255,255,255,0.95)");
      grad.addColorStop(1, "rgba(255,182,193,0.9)");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.ellipse(0, 0, w/2, h/2, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    });
    ctx.restore();
  }

  function drawGlow(alpha){
    const W = canvas.width;
    const H = canvas.height;
    ctx.save();
    const r = Math.max(W, H) * 0.55;
    const grad = ctx.createRadialGradient(
      W/2, H/2, r*0.1,
      W/2, H/2, r
    );
    grad.addColorStop(0, `rgba(255,255,255,${0.65*alpha})`);
    grad.addColorStop(1, "rgba(255,255,255,0)");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);
    ctx.restore();
  }

  // ===== メイン描画 =====
  function drawScene(scale=1, glowAlpha=0, withPetals=false){
    const base = baseImages[currentTemplate];
    if (!base || !base.ready) return;

    const W = canvas.width;
    const H = canvas.height;
    const bg = getBgConfig();

    ctx.clearRect(0,0,W,H);

    ctx.save();
    // 中心でふわっと拡大
    ctx.translate(W/2, H/2);
    ctx.scale(scale, scale);
    ctx.translate(-W/2, -H/2);

    // 背景色
    ctx.fillStyle = bg.color;
    ctx.fillRect(0,0,W,H);

    // ベース画像
    ctx.drawImage(base, 0, 0, W, H);

    // テキスト
    const text  = CANVAS_TEXT[currentLang] || CANVAS_TEXT.ja;
    const lay   = LAYOUT[currentTemplate] || LAYOUT.shuri;
    const tSize = TITLE_SIZES[currentLang] || TITLE_SIZES.en;
    const sSize = SUB_SIZES[currentLang]   || SUB_SIZES.en;

    drawText(text.title, W/2, lay.titleY, tSize, "700");
    drawText(text.sub,   W/2, lay.subY,   sSize, "600");

    const travelerName = (nameEl.value || "").trim() || text.traveler;
    drawNameText(travelerName, W/2, lay.travelerY);
    drawText("#wagyu_blessing", W/2, lay.hashY, 46, "600");

    ctx.restore();

    if (glowAlpha > 0){
      drawGlow(glowAlpha);
    }
    if (withPetals){
      drawPetals();
    }
  }

  function draw(){
    drawScene(1,0,false);
  }

  // ===== アニメーション =====
  function startBlessingAnimation(){
    createPetals();
    animStart = performance.now();
    lastTime = animStart;
    if (animId) cancelAnimationFrame(animId);

    function frame(now){
      const elapsed = now - animStart;
      const t = Math.min(1, elapsed / ANIM_DURATION);
      const dt = (now - lastTime) / 1000;
      lastTime = now;

      const scale = 1 + 0.09 * Math.sin(Math.PI * Math.min(1, t*2));  // ふわっと
      const glowAlpha = 1 - t;

      updatePetals(dt);
      drawScene(scale, glowAlpha, true);

      if (elapsed < ANIM_DURATION + 700 && petals.length > 0){
        animId = requestAnimationFrame(frame);
      } else {
        draw(); // 最終フレームを静止表示
      }
    }
    animId = requestAnimationFrame(frame);
  }

  // ===== ラッキー度 =====
  function updateLuckyMessage(){
    const list = LUCKY_MESSAGES[currentLang] || LUCKY_MESSAGES.en;
    const pick = list[Math.floor(Math.random() * list.length)];
    luckyEl.innerHTML = `<strong>${pick.stars}</strong> ${pick.text}`;
  }

  // ===== トースト =====
  let toastTimer = null;
  function showToast(){
    const msg = (UI_I18N[currentLang] || UI_I18N.ja).toast;
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      toastEl.classList.remove("show");
    }, 1800);
  }

  // ===== URL パラメータ =====
  function applyUrlState(){
    const params = new URLSearchParams(location.search);
    const lang = params.get("lang");
    if (lang && ["ja","en","zh"].includes(lang)) currentLang = lang;

    const bg = params.get("bg");
    if (bg && BG_COLORS.some(c => c.key === bg)) currentBgKey = bg;

    const tpl = params.get("tpl");
    if (tpl && TEMPLATES[tpl]) currentTemplate = tpl;

    const style = params.get("style");
    if (style && NAME_FONTS[style]) currentNameStyle = style;

    const name = params.get("name");
    if (name) nameEl.value = decodeURIComponent(name);

    langEl.value = currentLang;
    nameStyleEl.value = currentNameStyle;
  }

  function buildShareUrl(){
    const params = new URLSearchParams();
    params.set("lang", currentLang);
    params.set("bg", currentBgKey);
    params.set("tpl", currentTemplate);
    params.set("style", currentNameStyle);
    const nameVal = (nameEl.value || "").trim();
    if (nameVal) params.set("name", encodeURIComponent(nameVal));
    return `${location.origin}${location.pathname}?${params.toString()}`;
  }

  // ===== イベント設定 =====
  makeBtn.addEventListener("click", () => {
    startBlessingAnimation();
    updateLuckyMessage();
    showToast();
  });

  saveBtn.addEventListener("click", () => {
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  shareBtn.addEventListener("click", async () => {
    const url = buildShareUrl();
    const msg = (UI_I18N[currentLang] || UI_I18N.ja).shareCopied;
    if (navigator.share){
      try{
        await navigator.share({ url, text: "#wagyu_blessing" });
        return;
      }catch(e){}
    }
    if (navigator.clipboard){
      try{
        await navigator.clipboard.writeText(url);
        alert(msg);
        return;
      }catch(e){}
    }
    alert(url);
  });

  langEl.addEventListener("change", () => {
    currentLang = langEl.value;
    applyUILanguage();
    buildTemplateOptions();
    buildPalette();
    draw();
  });

  nameEl.addEventListener("input", () => {
    draw();
  });

  nameStyleEl.addEventListener("change", () => {
    currentNameStyle = nameStyleEl.value;
    draw();
  });

  templateEl.addEventListener("change", () => {
    currentTemplate = templateEl.value;
    const img = baseImages[currentTemplate];
    if (img && img.ready){
      draw();
    }else if(img){
      img.onload = () => { img.ready = true; draw(); };
    }
  });

  // ===== 初期表示 =====
  applyUrlState();
  applyUILanguage();
  buildTemplateOptions();
  buildPalette();
  draw();
<script>
  // PWA: Service Worker 登録
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./sw.js")
        .catch((err) => {
          console.error("Service Worker registration failed:", err);
        });
    });
  }
</script>
</body>
</html>
