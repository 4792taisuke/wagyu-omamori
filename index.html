<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wagyu Blessing Amulet | #wagyu_blessing</title>
  <meta name="description" content="Create a Japanese Omamori-style blessing card for travelers.">
  <style>
    :root{
      --bg: #10b7b0;
      --ink: #0f2b2e;
      --panel: #f5e7c4;
      --btn: #125a5a;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:#ece8d3;
    }
    header{padding:18px 22px}
    h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,36px)}
    .sub{opacity:.8}
    .wrap{
      display:grid;
      gap:20px;
      align-items:flex-start;
      grid-template-columns:minmax(280px,420px) 1fr;
      padding:0 22px 28px;
    }
    .card{
      background:#fffffff0;
      border:1px solid #0001;
      border-radius:16px;
      box-shadow:0 10px 24px #0001;
    }
    .panel{padding:16px;position:relative;z-index:1;}
    .controls .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    input,select,button{font-size:16px}
    input[type=text],select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #0002;
    }
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
    }
    .btn{background:var(--btn);color:#fff}
    .btn.alt{background:#fff;border:1px solid var(--btn);color:var(--btn)}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 18px;
      border-radius:999px;
      border:1px solid #0003;
      background:#fff;
      cursor:pointer;
      user-select:none;
      min-width:90px;
      text-align:center;
      box-shadow:0 2px 4px #0002;
      transition:transform .08s ease, box-shadow .08s ease, filter .08s ease;
    }
    .chip.active{
      box-shadow:0 0 0 3px #0f766e88;
      transform:translateY(-1px);
    }
    .chip:active{
      transform:scale(.96);
      box-shadow:0 1px 2px #0003;
    }
    .preview{display:grid;place-items:center;padding:10px}
    canvas{
      width:min(92%,520px);
      height:auto;
      max-height:78vh;
      aspect-ratio:2/3;
      display:block;
      background:transparent;
    }
    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      canvas{width:min(96%,560px)}
    }
    .hint{font-size:12px;opacity:.7;margin-top:-4px}
    .footer{padding:16px;text-align:center;opacity:.75}

    /* トースト（小さなメッセージ） */
    .toast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%) translateY(16px);
      padding:10px 18px;
      border-radius:999px;
      background:rgba(15,46,60,.94);
      color:#fff;
      font-size:14px;
      box-shadow:0 10px 24px #0005;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      z-index:50;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    /* ラッキー度メーター表示 */
    .lucky-box{
      margin-top:10px;
      font-size:12px;
      line-height:1.5;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(255,255,255,0.85);
      border:1px dashed #c2b58a;
      min-height:2.6em;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="heading">幸運を味わう — 旅の安全と長寿を願って。</h1>
    <div class="sub" id="subtext">
      沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！
      <strong>#wagyu_blessing</strong>
    </div>
  </header>

  <main class="wrap">
    <!-- 左：操作エリア -->
    <section class="card panel">
      <div class="controls">
        <div class="row">
          <label for="lang" id="label-lang">Language</label>
          <select id="lang">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div class="row"><label for="name" id="label-name">お名前（任意）</label></div>
        <div class="row">
          <input id="name" type="text" maxlength="24" placeholder="Traveler" />
        </div>

        <div class="row"><label id="label-bg">背景カラー（SNS映え）</label></div>
        <div id="palette" class="stack" aria-label="背景カラー"></div>

        <div class="row" style="gap:8px">
          <button class="btn" id="make" type="button">願いを込めて お守りを作る</button>
          <button class="btn alt" id="save" type="button">PNGを保存</button>
          <button class="btn alt" id="share" type="button">シェアする</button>
        </div>

        <p class="hint">
          ※ お名前は保存しません。お守り画像の生成のみに使用します。
        </p>

        <!-- ラッキー度メーター表示エリア -->
        <div id="lucky" class="lucky-box"></div>
      </div>
    </section>

    <!-- 右：プレビュー -->
    <section class="card preview">
      <canvas id="view" width="1200" height="1800" aria-label="お守りプレビュー"></canvas>
    </section>
  </main>

  <div class="footer">
    © Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>
  </div>

  <!-- トースト -->
  <div id="toast" class="toast">✨お守りに願いを込めました ✨</div>

<script>
  // ===== DOM 取得 =====
  const canvas   = document.getElementById("view");
  const ctx      = canvas.getContext("2d");
  const langEl   = document.getElementById("lang");
  const nameEl   = document.getElementById("name");
  const makeBtn  = document.getElementById("make");
  const saveBtn  = document.getElementById("save");
  const shareBtn = document.getElementById("share");
  const paletteEl= document.getElementById("palette");
  const toastEl  = document.getElementById("toast");
  const luckyEl  = document.getElementById("lucky");

  const headingEl = document.getElementById("heading");
  const subEl     = document.getElementById("subtext");
  const labelLang = document.getElementById("label-lang");
  const labelName = document.getElementById("label-name");
  const labelBg   = document.getElementById("label-bg");
  const footerEl  = document.querySelector(".footer");

  // ===== グローバル状態 =====
  let currentLang = langEl.value;        // "ja" / "en" / "zh"
  let currentBg   = "#10b7b0";           // 初期ターコイズ

  // アニメーション用
  let animating = false;
  let animStart = 0;
  let petals = [];
  let ring = null;

  // ===== 文字なしお守り画像 =====
  const base = new Image();
  base.src = "omamori_base.png";   // 既にアップしてある文字なしPNG
  let baseLoaded = false;

  base.onload = () => {
    baseLoaded = true;
    drawStatic();
  };

  // ===== キャンバス上のテキスト =====
  const CANVAS_I18N = {
    ja: {
      title: "旅のお守り",
      sub:   "安全な旅路と長寿を祈って",
      traveler: "Traveler",
    },
    en: {
      title: "Travel Blessing Charm",
      sub:   "For Safe Journeys & Long Life",
      traveler: "Traveler",
    },
    zh: {
      title: "祈福护身符",
      sub:   "旅途平安 · 长命百岁",
      traveler: "Traveler",
    },
  };

  // 言語ごとのレイアウト調整
  const LAYOUT = {
    ja: {
      titleY: 760,  titleSize: 82,
      subY:   850,  subSize:   40,
    },
    en: {
      titleY: 760,  titleSize: 70,
      subY:   845,  subSize:   38,
    },
    zh: {
      titleY: 760,  titleSize: 78,
      subY:   850,  subSize:   40,
    },
  };

  // ===== UI の文言 =====
  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelName:"お名前（任意）",
      labelBg:  "背景カラー（SNS映え）",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "シェアする",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      toast:    "✨お守りに願いを込めました ✨",
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelName:"Name (optional)",
      labelBg:  "Background color (for SNS)",
      btnMake:  "Bless my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      toast:    "✨ Your wish has been blessed ✨",
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelName:"姓名（可选）",
      labelBg:  "背景颜色（适合 SNS）",
      btnMake:  "为护身符注入祈愿",
      btnSave:  "保存 PNG",
      btnShare: "分享",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
      toast:    "✨ 祈愿已注入护身符 ✨",
    },
  };

  // ===== Lucky Score メッセージ =====
  const LUCKY_MESSAGES = {
    ja: [
      'Lucky score: ★★★★★<br>Wagyu Luck: 96% – 最高の旅日和です。',
      'Lucky score: ★★★★☆<br>Calm Sea, Safe Journey: 88% – のんびり安心トラベル。',
      'Lucky score: ★★★★☆<br>Travel Charm: 82% – 直感のまま出かけてみよう。'
    ],
    en: [
      'Lucky score: ★★★★★<br>Wagyu Luck: 96% – Perfect for new adventures.',
      'Lucky score: ★★★★☆<br>Calm Sea, Safe Journey: 88%.',
      'Lucky score: ★★★★☆<br>Travel Charm: 82% – Follow your curiosity.'
    ],
    zh: [
      'Lucky score: ★★★★★<br>Wagyu Luck: 96% – 今天非常适合新的旅程。',
      'Lucky score: ★★★★☆<br>Calm Sea, Safe Journey: 88% – 一路平安，好运相随。',
      'Lucky score: ★★★★☆<br>Travel Charm: 82% – 跟着好奇心去旅行吧。'
    ],
  };

  function updateLuckyScore() {
    const msgs = LUCKY_MESSAGES[currentLang] || LUCKY_MESSAGES.en;
    const msg  = msgs[Math.floor(Math.random() * msgs.length)];
    luckyEl.innerHTML = msg;
  }

  // ===== 背景色候補 =====
  const BG_COLORS = [
    {
      key: "deep",
      color: "#0b3b5a",
      labels: { ja: "深い藍", en: "Deep Indigo", zh: "深靛蓝" },
    },
    {
      key: "sakura",
      color: "#f9c5cf",
      labels: { ja: "桜ピンク", en: "Sakura Pink", zh: "樱花粉" },
    },
    {
      key: "jade",
      color: "#0f766e",
      labels: { ja: "翡翠グリーン", en: "Jade Green", zh: "翡翠绿" },
    },
    {
      key: "purple-gold",
      color: "#432f70",
      labels: { ja: "紫×金", en: "Purple × Gold", zh: "紫×金" },
    },
    {
      key: "ryukyu-blue",
      color: "#0077b6",
      labels: { ja: "琉球ブルー", en: "Ryukyu Blue", zh: "琉球蓝" },
    },
    {
      key: "sunset",
      color: "#f97316",
      labels: { ja: "サンセット", en: "Sunset Orange", zh: "夕阳橙" },
    },
    {
      key: "golden-hour",
      color: "#f6cf65",
      labels: { ja: "ゴールデンアワー", en: "Golden Hour", zh: "金色黄昏" },
    },
    {
      key: "turquoise",
      color: "#10b7b0",
      labels: { ja: "ターコイズ", en: "Turquoise", zh: "绿松石色" },
    },
  ];

  // ===== UIテキストを反映 =====
  function applyUILanguage() {
    const t = UI_I18N[currentLang];

    headingEl.textContent = t.heading;
    subEl.innerHTML       = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelName.textContent = t.labelName;
    labelBg.textContent   = t.labelBg;
    makeBtn.textContent   = t.btnMake;
    saveBtn.textContent   = t.btnSave;
    shareBtn.textContent  = t.btnShare;
    footerEl.innerHTML    = t.footer;
    toastEl.textContent   = t.toast;
  }

  // ===== 背景色ボタンを色付きで描き直す =====
  function isDarkColor(hex){
    const c = hex.replace("#","");
    const r = parseInt(c.substring(0,2),16);
    const g = parseInt(c.substring(2,4),16);
    const b = parseInt(c.substring(4,6),16);
    const brightness = (r*299 + g*587 + b*114)/1000;
    return brightness < 140;
  }

  function buildPalette() {
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (c.color === currentBg ? " active" : "");
      btn.dataset.color = c.color;
      btn.textContent   = c.labels[currentLang];
      btn.style.backgroundColor = c.color;
      btn.style.color = isDarkColor(c.color) ? "#fff" : "#132127";
      btn.style.borderColor = "#0005";
      btn.style.filter = "saturate(1.1)";
      paletteEl.appendChild(btn);
    });
  }

  // 背景色ボタンクリック
  paletteEl.addEventListener("click", (e) => {
    const target = e.target;
    if (!target.classList.contains("chip")) return;

    [...paletteEl.querySelectorAll(".chip")].forEach(b => b.classList.remove("active"));
    target.classList.add("active");

    currentBg = target.dataset.color;
    if (!animating) drawStatic();
  });

  // ===== キャンバスに文字を描くヘルパー =====
  function drawText(text, x, y, size, weight) {
    ctx.save();
    ctx.font = `${weight} ${size}px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  // ベース＋文字だけ（アニメなし）
  function drawStatic() {
    if (!baseLoaded) return;
    const W = canvas.width;
    const H = canvas.height;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = currentBg;
    ctx.fillRect(0,0,W,H);

    ctx.drawImage(base, 0, 0, W, H);

    const langData = CANVAS_I18N[currentLang] || CANVAS_I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;
    const travelerName = (nameEl.value || "").trim() || langData.traveler;

    drawText(langData.title,   W/2, layout.titleY, layout.titleSize, "700");
    drawText(langData.sub,     W/2, layout.subY,   layout.subSize,   "600");
    drawText(travelerName,     W/2, 1516,         100,              "700");
    drawText("#wagyu_blessing",W/2, 1618,          50,              "600");
  }

  // ===== トースト表示 =====
  let toastTimer = null;
  function showToast(){
    if (toastTimer) {
      clearTimeout(toastTimer);
      toastTimer = null;
    }
    toastEl.classList.add("show");
    toastTimer = setTimeout(() => {
      toastEl.classList.remove("show");
    }, 2200);
  }

  // ===== 桜吹雪：たっぷり＆ゆっくり落ちる =====
  function createPetals(){
    petals = [];
    const W = canvas.width;
    const H = canvas.height;
    const now = performance.now();

    const count = 120; // 多めに

    for (let i = 0; i < count; i++){
      const life = 2600 + Math.random()*900;  // 2.6〜3.5秒くらい
      petals.push({
        born: now,
        life,
        x0: Math.random()*W,
        amp: 40 + Math.random()*40,          // 左右への揺れ幅
        startY: -200 - Math.random()*200,    // かなり上から
        endY: H + 60 + Math.random()*40,     // 画面下あたりまで
        size: 24 + Math.random()*14,
        phase: Math.random()*Math.PI*2
      });
    }
  }

  function drawPetal(p, now){
    const age = now - p.born;
    if (age <= 0) return;

    const tRaw = age / p.life;
    if (tRaw >= 1) return;

    const t = tRaw;
    const ease = t * t * (3 - 2 * t); // smoothstep

    const y = p.startY + (p.endY - p.startY) * ease;
    const x = p.x0 + Math.sin(p.phase + age * 0.002) * p.amp;

    const alpha = 1 - t;
    const rot = p.phase * 2 + t * Math.PI * 1.2;

    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rot);
    ctx.globalAlpha = alpha;

    const w = p.size;
    const h = p.size * 0.6;

    const grd = ctx.createLinearGradient(-w/2,-h/2,w/2,h/2);
    grd.addColorStop(0, "#ffe4f0");
    grd.addColorStop(1, "#f472b6");
    ctx.fillStyle = grd;

    ctx.beginPath();
    ctx.moveTo(0, -h/2);
    ctx.quadraticCurveTo(w/2, -h/2, w/2, 0);
    ctx.quadraticCurveTo(w/2, h/2, 0, h/2);
    ctx.quadraticCurveTo(-w/2, h/2, -w/2, 0);
    ctx.quadraticCurveTo(-w/2, -h/2, 0, -h/2);
    ctx.closePath();
    ctx.fill();

    ctx.restore();
  }

  // 光のリング
  function startRing(){
    ring = {
      start: performance.now(),
      duration: 900
    };
  }

  function drawRing(now){
    if (!ring) return;
    const elapsed = now - ring.start;
    const t = Math.min(elapsed / ring.duration, 1);
    const W = canvas.width;
    const H = canvas.height;
    const maxR = 620;
    const minR = 380;
    const radius = minR + (maxR-minR)*t;
    const alpha  = 0.9*(1-t);

    ctx.save();
    ctx.translate(W/2,H/2);
    ctx.globalAlpha = alpha;

    const grd = ctx.createRadialGradient(0,0, radius*0.2, 0,0,radius);
    grd.addColorStop(0, "rgba(255,255,255,0.9)");
    grd.addColorStop(0.4, "rgba(255,255,200,0.6)");
    grd.addColorStop(1, "rgba(255,255,200,0.0)");
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(0,0,radius,0,Math.PI*2);
    ctx.fill();

    ctx.restore();

    if (t >= 1){
      ring = null;
    }
  }

  // ===== メインアニメーション =====
  function animate(now){
    if (!animating) return;

    const W = canvas.width;
    const H = canvas.height;
    const elapsed = now - animStart;
    const t = Math.min(elapsed / 1400, 1);   // 1.4秒でふわっと

    const easeOut = 1 - Math.pow(1-t, 3);
    const scale = 1 + 0.18 * Math.sin(easeOut * Math.PI);

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = currentBg;
    ctx.fillRect(0,0,W,H);

    ctx.save();
    ctx.translate(W/2,H/2);
    ctx.scale(scale, scale);
    ctx.translate(-W/2,-H/2);
    ctx.drawImage(base, 0, 0, W, H);

    const langData = CANVAS_I18N[currentLang] || CANVAS_I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;
    const travelerName = (nameEl.value || "").trim() || langData.traveler;
    drawText(langData.title,   W/2, layout.titleY, layout.titleSize, "700");
    drawText(langData.sub,     W/2, layout.subY,   layout.subSize,   "600");
    drawText(travelerName,     W/2, 1516,         100,              "700");
    drawText("#wagyu_blessing",W/2, 1618,          50,              "600");
    ctx.restore();

    drawRing(now);

    let alive = 0;
    for (const p of petals){
      const age = now - p.born;
      if (age < p.life){
        alive++;
        drawPetal(p, now);
      }
    }

    if (elapsed > 3200 && !ring && alive === 0){
      animating = false;
      drawStatic();
      return;
    }

    requestAnimationFrame(animate);
  }

  function triggerBlessing(){
    if (!baseLoaded) return;
    animating = true;
    animStart = performance.now();
    createPetals();
    startRing();
    requestAnimationFrame(animate);
  }

  // ===== イベント設定 =====
  makeBtn.addEventListener("click", () => {
    triggerBlessing();
    showToast();
    updateLuckyScore();   // ★ ラッキー度メーター更新
  });

  langEl.addEventListener("change", () => {
    currentLang = langEl.value;
    applyUILanguage();
    buildPalette();
    luckyEl.innerHTML = "";   // 言語切り替えで一度リセット
    if (!animating) drawStatic();
  });

  nameEl.addEventListener("input", () => {
    if (!animating) drawStatic();
  });

  // PNG保存
  saveBtn.addEventListener("click", () => {
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  // シェア
  shareBtn.addEventListener("click", () => {
    const tag = "#wagyu_blessing";
    if (navigator.share) {
      navigator.share({ text: tag });
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(tag);
      alert("ハッシュタグ " + tag + " をコピーしました。");
    }
  });

  // ===== 初期表示 =====
  applyUILanguage();
  buildPalette();
</script>
</body>
</html>
