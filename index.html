<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Wagyu Blessing Amulet | #wagyu_blessing</title>
  <meta name="description" content="Create a Japanese omamori-style blessing card for travelers. Okinawa Wagyu sandwich × lucky amulet generator.">

  <!-- PWA / アイコン関連 -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f766e">
  <link rel="apple-touch-icon" href="icons/wagyu-omamori-192.png">

  <style>
    :root{
      --bg-page: #ece8d3;
      --ink: #0f2b2e;
      --panel: #fefdf8;
      --btn-main: #125a5a;
      --btn-main-hover: #0b4848;
      --chip-border: #0002;
    }

    * { box-sizing: border-box; }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:var(--bg-page);
    }

    body{
      display:flex;
      flex-direction:column;
    }

    header{
      padding:18px 22px 8px;
    }

    h1{
      margin:0 0 6px;
      font-size:clamp(22px,3.2vw,34px);
    }

    .sub{
      opacity:.85;
      font-size:14px;
      line-height:1.5;
    }

    .wrap{
      flex:1;
      display:grid;
      gap:20px;
      align-items:flex-start;
      grid-template-columns:minmax(280px,420px) 1fr;
      padding:0 22px 28px;
    }

    .card{
      background:var(--panel);
      border:1px solid #0001;
      border-radius:16px;
      box-shadow:0 10px 24px #0001;
    }

    .panel{
      padding:16px;
      position:relative;
      z-index:1;
    }

    .controls .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin:10px 0;
      flex-wrap:wrap;
    }

    input,select,button{
      font-size:15px;
      font-family:inherit;
    }

    input[type=text],select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #0002;
      background:#fff;
    }

    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
      transition:background .18s, transform .08s, box-shadow .18s;
    }

    .btn-main{
      background:var(--btn-main);
      color:#fff;
      box-shadow:0 3px 8px #0003;
    }
    .btn-main:hover{
      background:var(--btn-main-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 14px #0004;
    }
    .btn-ghost{
      background:#fff;
      color:var(--btn-main);
      border:1px solid var(--btn-main);
    }
    .btn-ghost:hover{
      background:#f2faf9;
    }

    .stack{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .chip{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--chip-border);
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      min-width:88px;
      text-align:center;
      transition:transform .06s, box-shadow .12s, background .12s, color .12s, border-color .12s;
    }
    .chip.active{
      color:#fff;
      border-color:#0f766e;
      box-shadow:0 2px 8px #0003;
    }
    .chip:active{
      transform:scale(.97);
    }

    .preview{
      display:grid;
      place-items:center;
      padding:10px;
    }

    canvas{
      width:min(96%,540px);
      height:auto;
      max-height:80vh;
      aspect-ratio:2/3;
      display:block;
      background:transparent;
    }

    @media (max-width:940px){
      .wrap{ grid-template-columns:1fr; }
      canvas{ width:min(100%,560px); }
    }

    .hint{
      font-size:12px;
      opacity:.7;
      margin-top:-4px;
    }

    .footer{
      padding:12px 18px 16px;
      text-align:center;
      opacity:.78;
      font-size:12px;
    }

    .meta-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .meta-row > .field{
      flex:1 1 130px;
    }

    /* Lucky meter */
    #lucky-box{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#f3faf5;
      border:1px dashed #10b98155;
      font-size:13px;
      min-height:40px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    #lucky-score{
      font-weight:700;
    }
    #lucky-message{
      opacity:.85;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%) translateY(12px);
      background:rgba(0,0,0,.82);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 8px 20px #0006;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      z-index:50;
      white-space:nowrap;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1 id="heading">幸運を味わう — 旅の安全と長寿を願って。</h1>
    <div class="sub" id="subtext">
      沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！
      <strong>#wagyu_blessing</strong>
    </div>
  </header>

  <main class="wrap">
    <!-- 左：操作エリア -->
    <section class="card panel">
      <div class="controls">
        <!-- 言語 -->
        <div class="row">
          <label for="lang" id="label-lang">Language</label>
          <select id="lang">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <!-- 名前 -->
        <div class="row">
          <label for="name" id="label-name">お名前（任意）</label>
        </div>
        <div class="row">
          <input id="name" type="text" maxlength="24" placeholder="Traveler" />
        </div>

        <!-- 名前スタイル ＋ テンプレート -->
        <div class="row meta-row">
          <div class="field">
            <label for="nameStyle" id="label-style">Name Style</label>
            <select id="nameStyle">
              <option value="classic">Classic</option>
              <option value="hand">Handwritten</option>
              <option value="elegant">Elegant</option>
            </select>
          </div>
          <div class="field">
            <label for="template" id="label-template">Template</label>
            <select id="template"></select>
          </div>
        </div>

        <!-- 背景色 -->
        <div class="row">
          <label id="label-bg">背景カラー（SNS映え）</label>
        </div>
        <div id="palette" class="stack" aria-label="背景カラー"></div>

        <!-- ボタン -->
        <div class="row" style="gap:8px">
          <button class="btn-main" id="make" type="button">願いを込めて お守りを作る</button>
          <button class="btn-ghost" id="save" type="button">PNGを保存</button>
          <button class="btn-ghost" id="share" type="button">シェアする</button>
        </div>

        <p class="hint">
          ※ お名前は保存しません。お守り画像の生成のみに使用します。
        </p>

        <!-- Lucky meter -->
        <div id="lucky-box">
          <div id="lucky-score"></div>
          <div id="lucky-message"></div>
        </div>
      </div>
    </section>

    <!-- 右：プレビュー -->
    <section class="card preview">
      <canvas id="view" width="1200" height="1800" aria-label="お守りプレビュー"></canvas>
    </section>
  </main>

  <div class="footer">
    © Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

<script>
  // ========= DOM =========
  const canvas   = document.getElementById("view");
  const ctx      = canvas.getContext("2d");
  const langEl   = document.getElementById("lang");
  const nameEl   = document.getElementById("name");
  const nameStyleEl = document.getElementById("nameStyle");
  const tplEl    = document.getElementById("template");
  const makeBtn  = document.getElementById("make");
  const saveBtn  = document.getElementById("save");
  const shareBtn = document.getElementById("share");
  const paletteEl= document.getElementById("palette");

  const headingEl = document.getElementById("heading");
  const subEl     = document.getElementById("subtext");
  const labelLang = document.getElementById("label-lang");
  const labelName = document.getElementById("label-name");
  const labelStyle= document.getElementById("label-style");
  const labelTpl  = document.getElementById("label-template");
  const labelBg   = document.getElementById("label-bg");
  const footerEl  = document.querySelector(".footer");

  const luckyScoreEl   = document.getElementById("lucky-score");
  const luckyMessageEl = document.getElementById("lucky-message");
  const toastEl        = document.getElementById("toast");

  // ========= State =========
  let currentLang       = "ja";
  let currentBg         = "#10b7b0";
  let currentTpl        = "shuri";
  let currentNameStyle  = "classic";

  let baseImage   = new Image();
  let baseLoaded  = false;

  // アニメーション状態
  let animRunning = false;
  let animStart   = 0;
  const ANIM_DURATION = 2200;
  let petals = [];
  let animScale = 1;
  let ringStrength = 0;

  // ========= Canvas Text I18N =========
  const TEXT_I18N = {
    ja: {
      title: "旅のお守り",
      sub:   "安全な旅路と長寿を祈って",
      traveler: "Traveler"
    },
    en: {
      title: "Travel Blessing Charm",
      sub:   "For Safe Journeys & Long Life",
      traveler: "Traveler"
    },
    zh: {
      title: "祈福护身符",
      sub:   "旅途平安 · 长命百岁",
      traveler: "Traveler"
    }
  };

  const LAYOUT = {
    ja: { titleY: 720, subY: 830, titleSize: 88, subSize: 46 },
    en: { titleY: 710, subY: 820, titleSize: 78, subSize: 40 },
    zh: { titleY: 710, subY: 820, titleSize: 80, subSize: 42 }
  };

  // ========= UI I18N =========
  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelName:"お名前（任意）",
      labelStyle:"名前フォント",
      labelTpl:  "テンプレート",
      labelBg:   "背景カラー（SNS映え）",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "シェアする",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      toast:    "✨ お守りに願いを込めました ✨",
      luckyPrefix: "ラッキー度：",
      luckyMessages: [
        "Wagyu Luck 92% – 新しい冒険に最高の日！",
        "Calm Sea, Safe Journey: 78% – 今日は波も心もおだやか。",
        "88% – きっと素敵な出会いがあります。",
        "99% – 旅の神様が微笑んでいます。"
      ]
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelName:"Name (optional)",
      labelStyle:"Name Style",
      labelTpl:  "Template",
      labelBg:   "Background color (for SNS)",
      btnMake:  "Bless my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      toast:    "✨ Your wish has been blessed into the amulet ✨",
      luckyPrefix: "Lucky score:",
      luckyMessages: [
        "Wagyu Luck: 92% – Perfect for new adventures.",
        "Calm Sea, Safe Journey: 78%.",
        "88% – Today is a great day to travel.",
        "99% – Fortune is strongly on your side."
      ]
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelName:"姓名（可选）",
      labelStyle:"名字字体",
      labelTpl:  "模板",
      labelBg:   "背景颜色（适合 SNS）",
      btnMake:  "把愿望注入护身符",
      btnSave:  "保存 PNG",
      btnShare: "分享",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
      toast:    "✨ 您的愿望已经注入护身符 ✨",
      luckyPrefix: "幸运指数：",
      luckyMessages: [
        "和牛幸运：92% —— 适合开启新的旅程。",
        "平静海面 · 安心旅程：78%。",
        "88% —— 今天很适合出门旅行。",
        "99% —— 幸运女神正在对你微笑。"
      ]
    }
  };

  // ========= 背景色 =========
  const BG_COLORS = [
    {
      key: "deep",
      color: "#0b3b5a",
      labels: { ja: "深い藍", en: "Deep Indigo", zh: "深靛蓝" }
    },
    {
      key: "sakura",
      color: "#f9c5cf",
      labels: { ja: "桜ピンク", en: "Sakura Pink", zh: "樱花粉" }
    },
    {
      key: "jade",
      color: "#0f766e",
      labels: { ja: "翡翠グリーン", en: "Jade Green", zh: "翡翠绿" }
    },
    {
      key: "purple-gold",
      color: "#432f70",
      labels: { ja: "紫×金", en: "Purple × Gold", zh: "紫×金" }
    },
    {
      key: "ryukyu-blue",
      color: "#0077b6",
      labels: { ja: "琉球ブルー", en: "Ryukyu Blue", zh: "琉球蓝" }
    },
    {
      key: "sunset",
      color: "#f97316",
      labels: { ja: "サンセット", en: "Sunset Orange", zh: "夕阳橙" }
    },
    {
      key: "turquoise",
      color: "#10b7b0",
      labels: { ja: "ターコイズ", en: "Turquoise", zh: "绿松石色" }
    },
    {
      key: "golden-hour",
      color: "#f8c365",
      labels: { ja: "ゴールデンアワー", en: "Golden Hour", zh: "金色黄昏" }
    }
  ];

  // ========= テンプレート =========
  const TEMPLATE_DEFS = [
    {
      key: "shuri",
      src: "omamori_base.png",
      labels: { ja: "首里城", en: "Shuri Castle", zh: "首里城" }
    },
    {
      key: "ocean",
      src: "omamori_base_ocean.png",
      labels: { ja: "海とサンセット", en: "Ocean & Sunset", zh: "海与日落" }
    },
    {
      key: "flowers",
      src: "omamori_base_flowers.png",
      labels: { ja: "琉球の花", en: "Ryukyu Flowers", zh: "琉球之花" }
    },
    {
      key: "character",
      src: "omamori_base_character.png",
      labels: { ja: "キャラクター用", en: "Character Frame", zh: "角色用底图" }
    }
  ];

  const templateMap = Object.fromEntries(
    TEMPLATE_DEFS.map(t => [t.key, t])
  );

  // ========= 名前スタイル =========
  const NAME_STYLE_FONT = {
    classic: '700 100px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif',
    hand:    '700 100px "Comic Sans MS", "Yuji Syuku", system-ui, -apple-system, sans-serif',
    elegant: '700 100px "Georgia", "Times New Roman", "Noto Serif JP", serif'
  };

  // ========= ユーティリティ =========
  function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      lang: params.get("lang") || "ja",
      bg:   params.get("bg"),
      name: params.get("name"),
      tpl:  params.get("tpl") || "shuri",
      style:params.get("style") || "classic"
    };
  }

  function updateURLFromState() {
    const params = new URLSearchParams();
    params.set("lang", currentLang);
    params.set("bg",   currentBg);
    params.set("tpl",  currentTpl);
    params.set("style",currentNameStyle);
    const name = (nameEl.value || "").trim();
    if (name) params.set("name", name);

    const newUrl = `${location.pathname}?${params.toString()}`;
    history.replaceState(null, "", newUrl);
    return location.origin + location.pathname + "?" + params.toString();
  }

  function showToast(message) {
    toastEl.textContent = message;
    toastEl.classList.add("show");
    setTimeout(() => {
      toastEl.classList.remove("show");
    }, 1800);
  }

  // ========= UI テキスト反映 =========
  function applyUILanguage() {
    const t = UI_I18N[currentLang];

    headingEl.textContent = t.heading;
    subEl.innerHTML       = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelName.textContent = t.labelName;
    labelStyle.textContent= t.labelStyle;
    labelTpl.textContent  = t.labelTpl;
    labelBg.textContent   = t.labelBg;
    makeBtn.textContent   = t.btnMake;
    saveBtn.textContent   = t.btnSave;
    shareBtn.textContent  = t.btnShare;
    footerEl.innerHTML    = t.footer;
  }

  function buildPalette() {
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip";
      if (c.color === currentBg) btn.classList.add("active");
      btn.dataset.color = c.color;
      btn.style.background = c.color;
      if (c.color === currentBg) {
        btn.style.color = "#fff";
      }
      btn.textContent = c.labels[currentLang];
      paletteEl.appendChild(btn);
    });
  }

  function buildTemplateSelect() {
    tplEl.innerHTML = "";
    TEMPLATE_DEFS.forEach(tpl => {
      const opt = document.createElement("option");
      opt.value = tpl.key;
      opt.textContent = tpl.labels[currentLang];
      if (tpl.key === currentTpl) opt.selected = true;
      tplEl.appendChild(opt);
    });
  }

  // ========= Base 画像読み込み =========
  function loadBaseForTemplate(key) {
    const def = templateMap[key] || templateMap["shuri"];
    currentTpl = def.key;
    baseLoaded = false;
    baseImage = new Image();
    baseImage.onload = () => {
      baseLoaded = true;
      draw();
    };
    baseImage.src = def.src;
  }

  // ========= 描画ヘルパー =========
  function drawText(text, x, y, sizePx, weight, align="center", fontOverride=null) {
    ctx.save();
    ctx.textAlign = align;
    ctx.textBaseline = "middle";
    const baseFont = fontOverride || `${weight} ${sizePx}px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif`;
    ctx.font = baseFont;
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function drawPetal(p) {
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot);
    ctx.scale(p.scale, p.scale);
    ctx.beginPath();
    ctx.moveTo(0, -8);
    ctx.quadraticCurveTo(6, -2, 0, 10);
    ctx.quadraticCurveTo(-6, -2, 0, -8);
    ctx.closePath();
    ctx.fillStyle = `rgba(255, 192, 203, ${p.alpha})`;
    ctx.fill();
    ctx.restore();
  }

  // ========= メイン描画 =========
  function draw() {
    if (!baseLoaded) return;

    const W = canvas.width;
    const H = canvas.height;

    ctx.clearRect(0, 0, W, H);

    // 背景色
    ctx.fillStyle = currentBg;
    ctx.fillRect(0, 0, W, H);

    // スケール付き描画
    ctx.save();
    ctx.translate(W / 2, H / 2);
    ctx.scale(animScale, animScale);
    ctx.translate(-W / 2, -H / 2);

    // お守り本体
    ctx.drawImage(baseImage, 0, 0, W, H);

    // テキスト
    const langData = TEXT_I18N[currentLang] || TEXT_I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;
    const travelerName = (nameEl.value || "").trim() || langData.traveler;

    drawText(langData.title, W / 2, layout.titleY, layout.titleSize, "700");
    drawText(langData.sub,   W / 2, layout.subY,   layout.subSize,   "600");

    // Traveler（名前）
    const nameFont = NAME_STYLE_FONT[currentNameStyle] || NAME_STYLE_FONT.classic;
    drawText(travelerName, W / 2, 1516, 100, "700", "center", nameFont);

    // ハッシュタグ
    drawText("#wagyu_blessing", W / 2, 1618, 50, "600");

    // 光のリング
    if (ringStrength > 0) {
      const alpha = ringStrength;
      const radius = 320 + 90 * ringStrength;
      ctx.save();
      ctx.strokeStyle = `rgba(246, 216, 137, ${alpha})`;
      ctx.lineWidth = 22;
      ctx.beginPath();
      ctx.arc(W / 2, 350, radius, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();
    }

    // 桜
    if (petals.length) {
      petals.forEach(drawPetal);
    }

    ctx.restore();
  }

  // ========= アニメーション =========
  function createPetals() {
    const W = canvas.width;
    const H = canvas.height;
    const count = 60; // 多め
    const arr = [];
    for (let i = 0; i < count; i++) {
      arr.push({
        x: Math.random() * W,
        y: -Math.random() * 200,
        vy: 40 + Math.random() * 40,
        vx: -20 + Math.random() * 40,
        rot: Math.random() * Math.PI * 2,
        vr: -0.02 + Math.random() * 0.04,
        scale: 0.6 + Math.random() * 0.9,
        alpha: 0.9
      });
    }
    return arr;
  }

  function updateAnimation(timestamp) {
    if (!animRunning) return;

    const elapsed = timestamp - animStart;
    const t = Math.min(elapsed / ANIM_DURATION, 1);

    // ふわっとスケール
    if (t < 0.5) {
      animScale = 1 + 0.08 * (t / 0.5);
    } else {
      animScale = 1.08 - 0.08 * ((t - 0.5) / 0.5);
    }

    // 光のリング（先に強く、その後フェード）
    ringStrength = 1 - t;

    // 花びら
    const dt = 16 / 1000; // おおよそのフレーム時間
    const W = canvas.width;
    const H = canvas.height;

    petals.forEach(p => {
      p.y += p.vy * dt;
      p.x += p.vx * dt;
      p.rot += p.vr;
      // 画面下に行くほどゆっくりフェードアウト
      const ratio = p.y / H;
      p.alpha = Math.max(0, 1 - ratio);
    });

    petals = petals.filter(p => p.y < H + 40 && p.alpha > 0.02);

    draw();

    if (elapsed < ANIM_DURATION || petals.length > 0) {
      requestAnimationFrame(updateAnimation);
    } else {
      animRunning = false;
      animScale = 1;
      ringStrength = 0;
      petals = [];
      draw();
    }
  }

  function triggerBlessAnimation() {
    animRunning = true;
    animStart   = performance.now();
    animScale   = 1;
    ringStrength= 1;
    petals      = createPetals();
    requestAnimationFrame(updateAnimation);
  }

  // ========= Lucky メーター =========
  function updateLucky() {
    const t = UI_I18N[currentLang];
    const msgs = t.luckyMessages;
    const msg = msgs[Math.floor(Math.random() * msgs.length)];
    const stars = "★★★★★☆☆☆☆☆".slice(0, 5); // 表示用ダミー
    luckyScoreEl.textContent = `${t.luckyPrefix} ★★★★☆`;
    luckyMessageEl.textContent = msg;
  }

  // ========= イベント =========
  paletteEl.addEventListener("click", (e) => {
    const target = e.target;
    if (!target.classList.contains("chip")) return;

    const color = target.dataset.color;
    if (!color) return;

    currentBg = color;

    [...paletteEl.querySelectorAll(".chip")].forEach(b => {
      b.classList.remove("active");
      b.style.color = "";
    });
    target.classList.add("active");
    target.style.color = "#fff";

    updateURLFromState();
    draw();
  });

  tplEl.addEventListener("change", () => {
    currentTpl = tplEl.value;
    updateURLFromState();
    loadBaseForTemplate(currentTpl);
  });

  langEl.addEventListener("change", () => {
    currentLang = langEl.value;
    applyUILanguage();
    buildPalette();
    buildTemplateSelect();
    updateLucky();
    updateURLFromState();
    draw();
  });

  nameEl.addEventListener("input", () => {
    updateURLFromState();
    draw();
  });

  nameStyleEl.addEventListener("change", () => {
    currentNameStyle = nameStyleEl.value;
    updateURLFromState();
    draw();
  });

  makeBtn.addEventListener("click", () => {
    draw();
    triggerBlessAnimation();
    updateLucky();
    const t = UI_I18N[currentLang];
    showToast(t.toast);
    updateURLFromState();
  });

  saveBtn.addEventListener("click", () => {
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  shareBtn.addEventListener("click", () => {
    const url = updateURLFromState();
    if (navigator.share) {
      navigator.share({
        title: "Wagyu Blessing Amulet",
        text: "#wagyu_blessing",
        url
      }).catch(() => {});
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(url).then(() => {
        alert("このお守りのURLをコピーしました：\n" + url);
      });
    } else {
      alert(url);
    }
  });

  // ========= 初期化 =========
  function initFromURL() {
    const params = getQueryParams();

    currentLang = ["ja","en","zh"].includes(params.lang) ? params.lang : "ja";
    currentBg   = params.bg || currentBg;
    currentTpl  = templateMap[params.tpl] ? params.tpl : "shuri";
    currentNameStyle = NAME_STYLE_FONT[params.style] ? params.style : "classic";

    langEl.value = currentLang;
    nameStyleEl.value = currentNameStyle;

    if (params.name) {
      nameEl.value = params.name;
    }
  }

  function init() {
    initFromURL();
    applyUILanguage();
    buildPalette();
    buildTemplateSelect();
    updateLucky();
    loadBaseForTemplate(currentTpl);
  }

  init();

  // ========= Service Worker 登録 =========
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("./sw.js", { scope: "./" })
        .catch(err => {
          console.error("SW registration failed:", err);
        });
    });
  }
</script>
</body>
</html>
