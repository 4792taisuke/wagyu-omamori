<script>
  // ===== DOM 取得 =====
  const canvas   = document.getElementById("view");
  const ctx      = canvas.getContext("2d");
  const langEl   = document.getElementById("lang");
  const nameEl   = document.getElementById("name");
  const makeBtn  = document.getElementById("make");
  const saveBtn  = document.getElementById("save");
  const shareBtn = document.getElementById("share");
  const paletteEl= document.getElementById("palette");

  const headingEl = document.getElementById("heading");
  const subEl     = document.getElementById("subtext");
  const labelLang = document.getElementById("label-lang");
  const labelName = document.getElementById("label-name");
  const labelBg   = document.getElementById("label-bg");
  const footerEl  = document.querySelector(".footer");

  // ===== グローバル状態 =====
  let currentLang = langEl.value;        // "ja" / "en" / "zh"
  let currentBg   = "#10b7b0";           // 初期ターコイズ

  // ===== 文字なしお守り画像 =====
  const base = new Image();
  base.src = "omamori_base.png";         // 同じフォルダに置いた高解像度ベース
  let baseLoaded = false;

  base.onload = () => {
    baseLoaded = true;
    draw();
  };

  // ===== キャンバス上の文言 =====
  const I18N = {
    ja: {
      title: "旅のお守り",
      sub: "安全な旅路と長寿を祈って",
      traveler: "Traveler",
    },
    en: {
      title: "Travel Blessing Charm",
      sub:   "For Safe Journeys & Long Life",
      traveler: "Traveler",
    },
    zh: {
      title: "祈福护身符",
      sub:   "旅途平安 · 长命百岁",
      traveler: "Traveler",
    },
  };

  // ===== UI の文言 =====
  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelName:"お名前（任意）",
      labelBg:  "背景カラー（SNS映え）",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "シェアする",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelName:"Name (optional)",
      labelBg:  "Background color (for SNS)",
      btnMake:  "Create my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelName:"姓名（可选）",
      labelBg:  "背景颜色（适合 SNS）",
      btnMake:  "祈愿并生成护身符",
      btnSave:  "保存 PNG",
      btnShare: "分享",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
    },
  };

  // ===== 背景色候補 =====
  const BG_COLORS = [
    {
      key: "deep",
      color: "#0b3b5a",
      labels: { ja: "深い藍", en: "Deep Indigo", zh: "深靛蓝" },
    },
    {
      key: "sakura",
      color: "#f9c5cf",
      labels: { ja: "桜ピンク", en: "Sakura Pink", zh: "樱花粉" },
    },
    {
      key: "jade",
      color: "#0f766e",
      labels: { ja: "翡翠グリーン", en: "Jade Green", zh: "翡翠绿" },
    },
    {
      key: "purple-gold",
      color: "#432f70",
      labels: { ja: "紫×金", en: "Purple × Gold", zh: "紫×金" },
    },
    {
      key: "ryukyu-blue",
      color: "#0077b6",
      labels: { ja: "琉球ブルー", en: "Ryukyu Blue", zh: "琉球蓝" },
    },
    {
      key: "sunset",
      color: "#f97316",
      labels: { ja: "サンセット", en: "Sunset Orange", zh: "夕阳橙" },
    },
    {
      key: "turquoise",
      color: "#10b7b0",
      labels: { ja: "ターコイズ", en: "Turquoise", zh: "绿松石色" },
    },
  ];

  // ===== レイアウト（言語ごとにサイズを変える） =====
  const LAYOUT = {
    ja: {
      titleY: 750,
      titleSize: 90,
      subY: 845,
      subSize: 44,
    },
    en: {
      // 英語は横に長いので少し小さく
      titleY: 740,
      titleSize: 72,   // ★ここを小さめにして枠内に収める
      subY: 830,
      subSize: 40,
    },
    zh: {
      titleY: 750,
      titleSize: 80,
      subY: 845,
      subSize: 42,
    },
  };

  // ===== UIテキストを反映 =====
  function applyUILanguage() {
    const t = UI_I18N[currentLang];

    headingEl.textContent = t.heading;
    subEl.innerHTML       = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelName.textContent = t.labelName;
    labelBg.textContent   = t.labelBg;
    makeBtn.textContent   = t.btnMake;
    saveBtn.textContent   = t.btnSave;
    shareBtn.textContent  = t.btnShare;
    footerEl.innerHTML    = t.footer;
  }

  // ===== 背景色ボタンを描き直す =====
  function buildPalette() {
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (c.color === currentBg ? " active" : "");
      btn.dataset.color = c.color;
      btn.textContent   = c.labels[currentLang];
      paletteEl.appendChild(btn);
    });
  }

  // 背景色ボタンクリック
  paletteEl.addEventListener("click", (e) => {
    const target = e.target;
    if (!target.classList.contains("chip")) return;

    [...paletteEl.querySelectorAll(".chip")].forEach(b => b.classList.remove("active"));
    target.classList.add("active");

    currentBg = target.dataset.color;
    draw();
  });

  // ===== キャンバスに文字を描くヘルパー =====
  function drawText(text, x, y, size, weight) {
    ctx.save();
    ctx.font = `${weight} ${size}px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  // ===== メイン描画 =====
  function draw() {
    if (!baseLoaded) return;

    const W = canvas.width;
    const H = canvas.height;

    // 背景色
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = currentBg;
    ctx.fillRect(0, 0, W, H);

    // お守り本体
    ctx.drawImage(base, 0, 0, W, H);

    // 言語データ & レイアウト
    const langData = I18N[currentLang] || I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;

    const travelerName = (nameEl.value || "").trim() || langData.traveler;

    // タイトル
    drawText(langData.title, W / 2, layout.titleY, layout.titleSize, "700");

    // サブタイトル
    drawText(langData.sub,   W / 2, layout.subY,   layout.subSize,   "600");

    // Traveler（お名前）
    drawText(travelerName,        W / 2, 1516, 100, "700");

    // ハッシュタグ
    drawText("#wagyu_blessing",   W / 2, 1618, 50,  "600");
  }

  // ===== イベント設定 =====
  makeBtn.addEventListener("click", draw);
  langEl.addEventListener("change", () => {
    currentLang = langEl.value;
    applyUILanguage();
    buildPalette();
    draw();
  });
  nameEl.addEventListener("input", draw);

  // PNG保存
  saveBtn.addEventListener("click", () => {
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  // シェア
  shareBtn.addEventListener("click", () => {
    const tag = "#wagyu_blessing";
    if (navigator.share) {
      navigator.share({ text: tag });
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(tag);
      alert("ハッシュタグ " + tag + " をコピーしました。");
    }
  });

  // ===== 初期表示 =====
  applyUILanguage();
  buildPalette();
</script>
