<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wagyu Blessing Amulet | #wagyu_blessing</title>
  <meta name="description" content="Create a Japanese Omamori-style blessing card for travelers.">
  <style>
    :root{
      --bg: #10b7b0;
      --ink: #0f2b2e;
      --panel: #f5e7c4;
      --btn: #125a5a;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:#ece8d3;
    }
    header{padding:18px 22px}
    h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,36px)}
    .sub{opacity:.8}
    .wrap{
      display:grid;
      gap:20px;
      align-items:flex-start;
      grid-template-columns:minmax(280px,420px) 1fr;
      padding:0 22px 28px;
    }
    .card{
      background:#fffffff0;
      border:1px solid #0001;
      border-radius:16px;
      box-shadow:0 10px 24px #0001;
    }
    .panel{padding:16px;position:relative;z-index:1;}
    .controls .row{display:flex;gap:10px;align-items:center;margin:10px 0}
    input,select,button{font-size:16px}
    input[type=text],select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #0002;
      background:#fff;
    }
    button{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
    }
    .btn{background:var(--btn);color:#fff}
    .btn.alt{background:#fff;border:1px solid var(--btn);color:var(--btn)}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #0003;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease;
    }
    .chip.active{
      box-shadow:0 0 0 3px #0f766e66;
      transform:translateY(-1px);
    }
    .preview{display:grid;place-items:center;padding:10px}
    canvas{
      width:min(92%,520px);
      height:auto;
      max-height:78vh;
      aspect-ratio:2/3;
      display:block;
      background:transparent;
    }
    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      canvas{width:min(96%,560px)}
    }
    .hint{font-size:12px;opacity:.7;margin-top:-4px}
    .footer{padding:16px;text-align:center;opacity:.75;font-size:12px}
    .lucky{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #0001;
      background:#ffffffd0;
      font-size:13px;
      line-height:1.5;
      min-height:40px;
    }
    .lucky-score{font-weight:700;margin-bottom:2px}
    .toast{
      position:fixed;
      left:50%;
      bottom:26px;
      transform:translateX(-50%) translateY(8px);
      padding:8px 14px;
      border-radius:999px;
      background:rgba(0,0,0,.8);
      color:#fff;
      font-size:14px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:50;
      white-space:nowrap;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1 id="heading">幸運を味わう — 旅の安全と長寿を願って。</h1>
    <div class="sub" id="subtext">
      沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！
      <strong>#wagyu_blessing</strong>
    </div>
  </header>

  <main class="wrap">
    <!-- 左：操作エリア -->
    <section class="card panel">
      <div class="controls">
        <div class="row">
          <label for="lang" id="label-lang">Language</label>
          <select id="lang">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>

        <div class="row">
          <label for="template" id="label-template">デザイン</label>
          <select id="template">
            <option value="shuri">首里城</option>
            <option value="ocean">Ocean Sunset</option>
            <option value="flowers">Ryukyu Flowers</option>
          </select>
        </div>

        <div class="row">
          <label for="name" id="label-name">お名前（任意）</label>
        </div>
        <div class="row">
          <input id="name" type="text" maxlength="24" placeholder="Traveler" />
        </div>

        <div class="row">
          <label for="nameStyle" id="label-name-style">名前のスタイル</label>
          <select id="nameStyle">
            <option value="classic">Classic</option>
            <option value="handwritten">Handwritten</option>
            <option value="elegant">Elegant</option>
          </select>
        </div>

        <div class="row">
          <label id="label-bg">背景カラー（SNS映え）</label>
        </div>
        <div id="palette" class="stack" aria-label="背景カラー"></div>

        <div class="row" style="gap:8px;margin-top:14px">
          <button class="btn" id="make" type="button">願いを込めて お守りを作る</button>
          <button class="btn alt" id="save" type="button">PNGを保存</button>
          <button class="btn alt" id="share" type="button">シェアする</button>
        </div>

        <p class="hint">
          ※ お名前は保存しません。お守り画像の生成のみに使用します。
        </p>

        <div id="lucky" class="lucky"></div>
      </div>
    </section>

    <!-- 右：プレビュー -->
    <section class="card preview">
      <canvas id="view" width="1200" height="1800" aria-label="お守りプレビュー"></canvas>
    </section>
  </main>

  <div class="footer">
    © Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

<script>
  // ========= I18N =========
  const CANVAS_I18N = {
    ja: {
      title: "旅のお守り",
      sub: "安全な旅路と長寿を祈って",
      traveler: "Traveler",
    },
    en: {
      title: "Travel Blessing Charm",
      sub: "For Safe Journeys & Long Life",
      traveler: "Traveler",
    },
    zh: {
      title: "祈福护身符",
      sub: "旅途平安 · 长命百岁",
      traveler: "Traveler",
    },
  };

  const UI_I18N = {
    ja: {
      heading:  "幸運を味わう — 旅の安全と長寿を願って。",
      sub:      "沖縄発・幸運の和牛サンド｜SNS映えする日本のお守りデザインを作ってシェアしよう！",
      labelLang:"Language",
      labelTemplate: "デザイン",
      labelName:"お名前（任意）",
      labelNameStyle:"名前のスタイル",
      labelBg:  "背景カラー（SNS映え）",
      btnMake:  "願いを込めて お守りを作る",
      btnSave:  "PNGを保存",
      btnShare: "シェアする",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      toastWish:"✨お守りに願いを込めました ✨",
      toastShare:"リンクをコピーしました",
    },
    en: {
      heading:  "Taste Good Fortune – Wishing You Safe Travels and Long Life.",
      sub:      "From Okinawa: Wagyu Lucky Sandwich | Create a Japanese omamori-style design and share it on SNS!",
      labelLang:"Language",
      labelTemplate: "Design",
      labelName:"Name (optional)",
      labelNameStyle:"Name style",
      labelBg:  "Background color (for SNS)",
      btnMake:  "Create my amulet",
      btnSave:  "Save PNG",
      btnShare: "Share",
      footer:   "© Wagyu Blessing — Hashtag: <strong>#wagyu_blessing</strong>",
      toastWish:"✨ Your wish has been sealed in the amulet ✨",
      toastShare:"Link copied to clipboard",
    },
    zh: {
      heading:  "品尝幸运 —— 祝您旅途平安、长命百岁。",
      sub:      "来自冲绳的和牛幸运三明治｜制作日本御守风格的设计并分享到 SNS！",
      labelLang:"语言",
      labelTemplate: "设计",
      labelName:"姓名（可选）",
      labelNameStyle:"名字风格",
      labelBg:  "背景颜色（适合 SNS）",
      btnMake:  "祈愿并生成护身符",
      btnSave:  "保存 PNG",
      btnShare: "分享",
      footer:   "© Wagyu Blessing — 话题标签：<strong>#wagyu_blessing</strong>",
      toastWish:"✨ 已把你的心愿注入护身符 ✨",
      toastShare:"链接已复制",
    },
  };

  const NAME_STYLE_LABELS = {
    ja: {
      classic: "クラシック",
      handwritten: "手書き風",
      elegant: "エレガント",
    },
    en: {
      classic: "Classic",
      handwritten: "Handwritten",
      elegant: "Elegant",
    },
    zh: {
      classic: "经典",
      handwritten: "手写风",
      elegant: "优雅",
    },
  };

  // レイアウト（言語別の文字サイズと位置）
  const LAYOUT = {
    ja: { titleY: 730, titleSize: 86, subY: 825, subSize: 44 },
    en: { titleY: 730, titleSize: 72, subY: 820, subSize: 40 },
    zh: { titleY: 730, titleSize: 80, subY: 825, subSize: 44 },
  };

  const LUCKY_MESSAGES = {
    ja: [
      { score:"★★★★★", text:"今日は最高の旅日和。新しい出会いに期待！" },
      { score:"★★★★☆", text:"和牛パワーで運気アップ。SNS映えスポットをたくさん巡ろう。" },
      { score:"★★★☆☆", text:"ゆったり穏やかな一日。のんびり沖縄時間を楽しめそうです。" },
    ],
    en: [
      { score:"★★★★★", text:"Wagyu Luck: 96% – Perfect for new adventures." },
      { score:"★★★★☆", text:"Calm Sea, Safe Journey: 82% – Great day for exploring." },
      { score:"★★★☆☆", text:"Slow & easy day – take it at your own pace." },
    ],
    zh: [
      { score:"★★★★★", text:"和牛幸运指数 95% —— 非常适合开启新的旅程。" },
      { score:"★★★★☆", text:"海面平静 · 旅途顺利：82%" },
      { score:"★★★☆☆", text:"适合慢悠悠地散步拍照的一天。" },
    ],
  };

  // 背景カラー
  const BG_COLORS = [
    { key:"deep",   color:"#0b3b5a", labels:{ja:"深い藍",      en:"Deep Indigo",    zh:"深靛蓝"} },
    { key:"sakura", color:"#f9c5cf", labels:{ja:"桜ピンク",    en:"Sakura Pink",    zh:"樱花粉"} },
    { key:"jade",   color:"#0f766e", labels:{ja:"翡翠グリーン", en:"Jade Green",     zh:"翡翠绿"} },
    { key:"purple-gold", color:"#432f70", labels:{ja:"紫×金",  en:"Purple × Gold",  zh:"紫×金"} },
    { key:"ryukyu-blue", color:"#0077b6", labels:{ja:"琉球ブルー",en:"Ryukyu Blue",  zh:"琉球蓝"} },
    { key:"sunset", color:"#f97316", labels:{ja:"サンセット",  en:"Sunset Orange",  zh:"夕阳橙"} },
    { key:"turquoise", color:"#10b7b0", labels:{ja:"ターコイズ", en:"Turquoise",     zh:"绿松石色"} },
    { key:"golden-hour", color:"#fbbf24", labels:{ja:"ゴールデンアワー", en:"Golden Hour", zh:"黄金时刻"} },
  ];

  // テンプレート画像
  const TEMPLATE_FILES = {
    shuri:   "omamori_base.png",
    ocean:   "omamori_base_ocean.png",
    flowers: "omamori_base_flowers.png",
  };

  const TEMPLATE_LABELS = {
    ja:{ shuri:"首里城", ocean:"海とサンセット", flowers:"琉球の花"},
    en:{ shuri:"Shuri Castle", ocean:"Ocean & Sunset", flowers:"Ryukyu Flowers"},
    zh:{ shuri:"首里城", ocean:"海滩日落", flowers:"琉球花纹"},
  };

  const NAME_FONTS = {
    classic: '"Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif',
    handwritten: '"Patrick Hand", "Comic Sans MS", system-ui, -apple-system, "Segoe UI", sans-serif',
    elegant: '"Georgia", "Times New Roman", "Yu Mincho", serif',
  };

  // ========= DOM 取得 =========
  const canvas   = document.getElementById("view");
  const ctx      = canvas.getContext("2d");
  const langEl   = document.getElementById("lang");
  const nameEl   = document.getElementById("name");
  const makeBtn  = document.getElementById("make");
  const saveBtn  = document.getElementById("save");
  const shareBtn = document.getElementById("share");
  const paletteEl= document.getElementById("palette");
  const templateEl = document.getElementById("template");
  const nameStyleEl = document.getElementById("nameStyle");
  const luckyEl  = document.getElementById("lucky");
  const toastEl  = document.getElementById("toast");

  const headingEl = document.getElementById("heading");
  const subEl     = document.getElementById("subtext");
  const labelLang = document.getElementById("label-lang");
  const labelTemplate = document.getElementById("label-template");
  const labelName = document.getElementById("label-name");
  const labelNameStyle = document.getElementById("label-name-style");
  const labelBg   = document.getElementById("label-bg");
  const footerEl  = document.querySelector(".footer");

  // ========= グローバル状態 =========
  let currentLang = langEl.value; // "ja" / "en" / "zh"
  let currentBgKey = "turquoise";
  let currentBgColor = "#10b7b0";
  let currentTemplate = "shuri";
  let currentNameStyle = "classic";

  const baseImages = {};
  let baseLoadedFlags = {};
  Object.keys(TEMPLATE_FILES).forEach(key => {
    const img = new Image();
    img.src = TEMPLATE_FILES[key];
    baseImages[key] = img;
    baseLoadedFlags[key] = false;
    img.onload = () => {
      baseLoadedFlags[key] = true;
      if (key === currentTemplate) {
        draw();
      }
    };
  });

  // アニメーション用
  let petals = [];
  let animStart = 0;
  let animFrameId = null;
  const MAIN_ANIM_DURATION = 900;  // ふわっと + 光のリング
  const PETAL_DURATION_EXTRA = 3800; // 花びらが落ちきるまで
  let lastTime = 0;

  // ========= ユーティリティ =========
  function getBgColorByKey(key){
    const item = BG_COLORS.find(c=>c.key===key);
    return item ? item.color : "#10b7b0";
  }

  function getContrastColor(hex){
    const m = /^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(hex);
    if(!m) return "#111";
    const r = parseInt(m[1],16)/255;
    const g = parseInt(m[2],16)/255;
    const b = parseInt(m[3],16)/255;
    const lum = 0.2126*r + 0.7152*g + 0.0722*b;
    return lum > 0.6 ? "#111" : "#fff";
  }

  function showToast(message){
    toastEl.textContent = message;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1800);
  }

  // ========= UI 文言の反映 =========
  function applyUILanguage(){
    const t = UI_I18N[currentLang];

    headingEl.textContent = t.heading;
    subEl.innerHTML       = `${t.sub} <strong>#wagyu_blessing</strong>`;
    labelLang.textContent = t.labelLang;
    labelTemplate.textContent = t.labelTemplate;
    labelName.textContent = t.labelName;
    labelNameStyle.textContent = t.labelNameStyle;
    labelBg.textContent   = t.labelBg;
    makeBtn.textContent   = t.btnMake;
    saveBtn.textContent   = t.btnSave;
    shareBtn.textContent  = t.btnShare;
    footerEl.innerHTML    = t.footer;

    // テンプレートのラベル
    const tplLabels = TEMPLATE_LABELS[currentLang];
    [...templateEl.options].forEach(opt=>{
      opt.textContent = tplLabels[opt.value];
    });

    // 名前スタイルのラベル
    const styleLabels = NAME_STYLE_LABELS[currentLang];
    nameStyleEl.querySelector('option[value="classic"]').textContent    = styleLabels.classic;
    nameStyleEl.querySelector('option[value="handwritten"]').textContent= styleLabels.handwritten;
    nameStyleEl.querySelector('option[value="elegant"]').textContent    = styleLabels.elegant;

    // ラッキー表示も言語に合わせて作り直す
    updateLuckyMessage();
  }

  // 背景色ボタンを描画
  function buildPalette(){
    paletteEl.innerHTML = "";
    BG_COLORS.forEach(c=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (c.key === currentBgKey ? " active" : "");
      btn.dataset.key = c.key;
      btn.dataset.color = c.color;
      btn.textContent   = c.labels[currentLang];
      btn.style.backgroundColor = c.color;
      btn.style.color = getContrastColor(c.color);
      paletteEl.appendChild(btn);
    });
  }

  function updateLuckyMessage(){
    const list = LUCKY_MESSAGES[currentLang] || LUCKY_MESSAGES.en;
    const item = list[Math.floor(Math.random()*list.length)];
    luckyEl.innerHTML =
      `<div class="lucky-score">Lucky score: ${item.score}</div>`+
      `<div class="lucky-text">${item.text}</div>`;
  }

  // ========= テキスト描画系 =========
  function drawText(text, x, y, size, weight){
    ctx.save();
    ctx.font = `${weight} ${size}px "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function drawName(text, x, y, size, weight){
    const family = NAME_FONTS[currentNameStyle] || NAME_FONTS.classic;
    ctx.save();
    ctx.font = `${weight} ${size}px ${family}`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#221811";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function drawTexts(){
    const W = canvas.width;
    const langData = CANVAS_I18N[currentLang] || CANVAS_I18N.ja;
    const layout   = LAYOUT[currentLang] || LAYOUT.ja;
    const travelerName = (nameEl.value || "").trim() || langData.traveler;

    drawText(langData.title, W/2, layout.titleY, layout.titleSize, "700");
    drawText(langData.sub,   W/2, layout.subY,   layout.subSize,   "600");
    drawName(travelerName,   W/2, 1516, 100, "700");
    drawText("#wagyu_blessing", W/2, 1618, 50, "600");
  }

  // ========= 描画関数 =========
  function drawStatic(){
    const W = canvas.width;
    const H = canvas.height;
    const img = baseImages[currentTemplate];
    if (!img || !baseLoadedFlags[currentTemplate]) return;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = currentBgColor;
    ctx.fillRect(0,0,W,H);

    ctx.drawImage(img, 0, 0, W, H);
    drawTexts();
  }

  function draw(progress, elapsed){
    const W = canvas.width;
    const H = canvas.height;
    const img = baseImages[currentTemplate];
    if (!img || !baseLoadedFlags[currentTemplate]) return;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = currentBgColor;
    ctx.fillRect(0,0,W,H);

    // ふわっと拡大
    const pulse = Math.sin((progress || 0) * Math.PI);
    const scale = 1 + 0.06 * pulse;

    const cx = W/2;
    const cy = H/2;

    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(scale, scale);
    ctx.drawImage(img, -W/2, -H/2, W, H);
    ctx.restore();

    // テキスト
    drawTexts();

    // 光のリング（上部の菊のあたり）
    if (progress < 1){
      const ringCenterY = H*0.23;
      const maxR = W*0.42;
      const radius = maxR * progress;
      const alpha  = 0.9 * (1 - progress);

      ctx.save();
      ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
      ctx.lineWidth = 10;
      ctx.beginPath();
      ctx.arc(cx, ringCenterY, radius, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // 桜の花びら
    if (petals.length){
      petals.forEach(p=>{
        // 経過時間に応じて更新
        const t = elapsed - p.startTime;
        if (t < 0) return;
        const fallProgress = t / p.life;
        if (fallProgress > 1) {
          p.dead = true;
          return;
        }

        const baseY = -50 + (H + 160) * fallProgress;
        const sway = Math.sin(p.swaySpeed * t + p.seed) * p.swayAmount;
        const x = p.x + sway;
        const y = baseY;

        const rot = p.rotationStart + p.rotationSpeed * t;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        const size = p.size;
        const grad = ctx.createLinearGradient(-size, -size, size, size);
        grad.addColorStop(0, "rgba(255,255,255,0.95)");
        grad.addColorStop(1, "rgba(255,192,203,0.85)");
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(0, -size);
        ctx.quadraticCurveTo(size, -size*0.2, 0, size);
        ctx.quadraticCurveTo(-size, -size*0.2, 0, -size);
        ctx.fill();
        ctx.restore();
      });
      petals = petals.filter(p=>!p.dead);
    }
  }

  // ========= アニメーション =========
  function startWishAnimation(){
    const now = performance.now();
    animStart = now;
    lastTime = now;

    // 花びら生成（たっぷり）
    const W = canvas.width;
    const count = 70;
    petals = [];
    for (let i=0;i<count;i++){
      petals.push({
        x: Math.random()*W,
        size: 12 + Math.random()*16,
        swayAmount: 30 + Math.random()*50,
        swaySpeed: 0.002 + Math.random()*0.002,
        rotationStart: Math.random()*Math.PI*2,
        rotationSpeed: (Math.random()*0.002 + 0.001) * (Math.random()<0.5?-1:1),
        life: MAIN_ANIM_DURATION + PETAL_DURATION_EXTRA + Math.random()*800,
        startTime: now + Math.random()*300, // 少しずつ降り始める
        seed: Math.random()*10,
        dead:false,
      });
    }

    if (animFrameId) cancelAnimationFrame(animFrameId);
    animFrameId = requestAnimationFrame(stepAnimation);
  }

  function stepAnimation(time){
    const elapsed = time - animStart;
    const progress = Math.min(elapsed / MAIN_ANIM_DURATION, 1);

    draw(progress, elapsed);

    const petalsAlive = petals.some(p => !p.dead);
    if (elapsed < MAIN_ANIM_DURATION + PETAL_DURATION_EXTRA || petalsAlive){
      animFrameId = requestAnimationFrame(stepAnimation);
    } else {
      animFrameId = null;
      petals = [];
      drawStatic(); // 最終フレーム
    }
  }

  // ========= URL & シェア =========
  function initFromURL(){
    try{
      const params = new URLSearchParams(window.location.search);

      const urlLang = params.get("lang");
      if (urlLang && CANVAS_I18N[urlLang]) currentLang = urlLang;

      const urlBg = params.get("bg");
      if (urlBg && BG_COLORS.some(c=>c.key===urlBg)){
        currentBgKey = urlBg;
        currentBgColor = getBgColorByKey(urlBg);
      }

      const urlTemplate = params.get("template");
      if (urlTemplate && TEMPLATE_FILES[urlTemplate]){
        currentTemplate = urlTemplate;
      }

      const urlStyle = params.get("style");
      if (urlStyle && NAME_FONTS[urlStyle]){
        currentNameStyle = urlStyle;
      }

      const urlName = params.get("name");
      if (urlName){
        nameEl.value = decodeURIComponent(urlName);
      }

      langEl.value = currentLang;
      templateEl.value = currentTemplate;
      nameStyleEl.value = currentNameStyle;
    }catch(e){
      // 無視してデフォルト
    }
  }

  function buildShareURL(){
    const url = new URL(window.location.href);
    const params = url.searchParams;
    params.set("lang", currentLang);
    params.set("bg", currentBgKey);
    params.set("template", currentTemplate);
    params.set("style", currentNameStyle);
    const nameVal = (nameEl.value || "").trim();
    if (nameVal){
      params.set("name", encodeURIComponent(nameVal));
    } else {
      params.delete("name");
    }
    url.search = params.toString();
    return url.toString();
  }

  // ========= イベント =========
  paletteEl.addEventListener("click", (e)=>{
    const target = e.target;
    if (!target.classList.contains("chip")) return;
    const key = target.dataset.key;
    currentBgKey = key;
    currentBgColor = target.dataset.color || getBgColorByKey(key);
    [...paletteEl.querySelectorAll(".chip")].forEach(b=>b.classList.remove("active"));
    target.classList.add("active");
    drawStatic();
  });

  langEl.addEventListener("change", ()=>{
    currentLang = langEl.value;
    applyUILanguage();
    buildPalette();
    drawStatic();
  });

  templateEl.addEventListener("change", ()=>{
    currentTemplate = templateEl.value;
    if (baseLoadedFlags[currentTemplate]){
      drawStatic();
    }
  });

  nameEl.addEventListener("input", ()=>{
    drawStatic();
  });

  nameStyleEl.addEventListener("change", ()=>{
    currentNameStyle = nameStyleEl.value;
    drawStatic();
  });

  makeBtn.addEventListener("click", ()=>{
    const ui = UI_I18N[currentLang] || UI_I18N.ja;
    showToast(ui.toastWish);
    updateLuckyMessage();
    startWishAnimation();
  });

  saveBtn.addEventListener("click", ()=>{
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data;
    a.download = "wagyu_omamori.png";
    a.click();
  });

  shareBtn.addEventListener("click", async ()=>{
    const ui = UI_I18N[currentLang] || UI_I18N.ja;
    const shareUrl = buildShareURL();
    try{
      if (navigator.share){
        await navigator.share({ url: shareUrl, text: "#wagyu_blessing" });
      }else if (navigator.clipboard){
        await navigator.clipboard.writeText(shareUrl);
        showToast(ui.toastShare);
      }else{
        window.prompt("Copy this URL", shareUrl);
      }
    }catch(e){
      // キャンセルは無視
    }
  });

  // ========= 初期化 =========
  initFromURL();
  applyUILanguage();
  buildPalette();
  updateLuckyMessage();
  drawStatic();
</script>
</body>
</html>
